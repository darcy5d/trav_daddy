{% extends "base.html" %}

{% block title %}Match Prediction - Cricket Predictor{% endblock %}

{% block content %}
<div class="hero" style="padding: 2rem;">
    <h1>Match Prediction</h1>
    <p>Select teams and players to simulate T20 matches</p>
    
    <!-- Gender Toggle -->
    <div style="margin-top: 1rem; display: flex; justify-content: center; gap: 1rem;">
        <button id="gender-male" class="btn btn-primary" onclick="setGender('male')" style="min-width: 150px;">
            üèè Men's T20
        </button>
        <button id="gender-female" class="btn" onclick="setGender('female')" style="min-width: 150px;">
            üèè Women's T20
        </button>
    </div>
</div>

<!-- T20 Match Loader (Works for all genders) -->
<div id="t20-loader" class="card" style="margin-bottom: 1.5rem; border: 2px solid var(--accent-primary);">
    <h2 class="card-title" style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="font-size: 1.5rem;">üèè</span> <span id="loader-title">Load T20 Match</span>
    </h2>
    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
        Select a competition and upcoming match to auto-fill both teams with their most recent lineups.
    </p>
    
    <div class="grid grid-3" style="gap: 1rem; align-items: end;">
        <div class="form-group" style="margin: 0;">
            <label>Competition / Series</label>
            <select id="series-select" onchange="loadSeriesFixtures()" style="width: 100%;">
                <option value="">-- Select Competition --</option>
            </select>
        </div>
        <div class="form-group" style="margin: 0;">
            <label>Upcoming Fixtures</label>
            <select id="fixture-select" style="width: 100%;">
                <option value="">-- Select a Match --</option>
            </select>
        </div>
        <div class="form-group" style="margin: 0;">
            <label>&nbsp;</label>
            <button class="btn btn-primary" onclick="loadT20Match()" style="width: 100%;">
                Load Squads
            </button>
        </div>
    </div>
    
    <div id="t20-loading" style="display: none; text-align: center; padding: 1rem;">
        <div class="spinner" style="margin: 0 auto;"></div>
        <p style="color: var(--text-secondary); margin-top: 0.5rem;">Loading squads from API...</p>
    </div>
    
    <div id="t20-match-info" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <strong id="t20-match-name"></strong>
            <span id="t20-match-date" style="color: var(--text-muted);"></span>
        </div>
        <div style="font-size: 0.875rem; color: var(--text-secondary);">
            <span id="t20-team1-info"></span> vs <span id="t20-team2-info"></span>
        </div>
    </div>
</div>

<div class="grid grid-2">
    <!-- Team 1 Selection -->
    <div class="card">
        <h2 class="card-title" style="color: var(--accent-primary);">Team 1</h2>
        
        <div class="form-group">
            <label>Select Team</label>
            <select id="team1-select" onchange="loadPlayers(1)">
                <option value="">-- Select Team --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Batters (select 11)</label>
            <select id="team1-batters" multiple size="8" style="min-height: 200px;">
            </select>
            <small style="color: var(--text-muted);">Hold Ctrl/Cmd to select multiple</small>
        </div>
        
        <div class="form-group">
            <label>Bowlers (select 5)</label>
            <select id="team1-bowlers" multiple size="5" style="min-height: 120px;">
            </select>
        </div>
    </div>
    
    <!-- Team 2 Selection -->
    <div class="card">
        <h2 class="card-title" style="color: var(--accent-secondary);">Team 2</h2>
        
        <div class="form-group">
            <label>Select Team</label>
            <select id="team2-select" onchange="loadPlayers(2)">
                <option value="">-- Select Team --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Batters (select 11)</label>
            <select id="team2-batters" multiple size="8" style="min-height: 200px;">
            </select>
            <small style="color: var(--text-muted);">Hold Ctrl/Cmd to select multiple</small>
        </div>
        
        <div class="form-group">
            <label>Bowlers (select 5)</label>
            <select id="team2-bowlers" multiple size="5" style="min-height: 120px;">
            </select>
        </div>
    </div>
</div>

<!-- Venue Selection -->
<div class="card">
    <h2 class="card-title">Match Conditions</h2>
    <div class="grid grid-2">
        <div class="form-group">
            <label>Venue (affects scoring patterns)</label>
            <select id="venue-select">
                <option value="">-- Neutral Venue --</option>
            </select>
            <small style="color: var(--text-muted);" id="venue-info"></small>
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="use-toss" style="width: auto;">
                Simulate Toss
            </label>
            <small style="color: var(--text-muted);">Uses historical bat/field preferences (T20: 55% elect to field)</small>
        </div>
    </div>
</div>

<!-- Simulation Options -->
<div class="card">
    <h2 class="card-title">Simulation Options</h2>
    <div class="grid grid-3">
        <div class="form-group">
            <label>Simulator Engine</label>
            <select id="simulator-type">
                <option value="fast">Fast Lookup (0.1ms/match)</option>
                <option value="nn" selected>Neural Network (5ms/match) + Scorecard</option>
            </select>
        </div>
        <div class="form-group">
            <label>Number of Simulations</label>
            <input type="number" id="n-simulations" value="1000" min="100" max="10000" step="100">
        </div>
        <div class="form-group">
            <label>&nbsp;</label>
            <button class="btn btn-primary" onclick="runSimulation()" style="width: 100%;">
                Run Simulation
            </button>
        </div>
    </div>
</div>

<!-- Results -->
<div id="results" class="card" style="display: none;">
    <h2 class="card-title">Prediction Results</h2>
    
    <div class="grid grid-2" style="margin-bottom: 2rem;">
        <!-- Team 1 Result -->
        <div style="text-align: center; padding: 2rem; background: var(--bg-tertiary); border-radius: 12px;">
            <div style="font-size: 1.25rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                <span id="result-team1-name">Team 1</span>
            </div>
            <div class="stat-value" style="color: var(--accent-primary);" id="result-team1-prob">--%</div>
            <div class="probability-bar">
                <div class="probability-fill" id="result-team1-bar" style="background: var(--accent-primary); width: 0%;"></div>
            </div>
            <div style="margin-top: 1rem; color: var(--text-secondary);">
                Avg Score: <span id="result-team1-score">--</span>
            </div>
            <div style="color: var(--text-muted); font-size: 0.875rem;">
                Range: <span id="result-team1-range">-- - --</span>
            </div>
        </div>
        
        <!-- Team 2 Result -->
        <div style="text-align: center; padding: 2rem; background: var(--bg-tertiary); border-radius: 12px;">
            <div style="font-size: 1.25rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                <span id="result-team2-name">Team 2</span>
            </div>
            <div class="stat-value" style="color: var(--accent-secondary);" id="result-team2-prob">--%</div>
            <div class="probability-bar">
                <div class="probability-fill" id="result-team2-bar" style="background: var(--accent-secondary); width: 0%;"></div>
            </div>
            <div style="margin-top: 1rem; color: var(--text-secondary);">
                Avg Score: <span id="result-team2-score">--</span>
            </div>
            <div style="color: var(--text-muted); font-size: 0.875rem;">
                Range: <span id="result-team2-range">-- - --</span>
            </div>
        </div>
    </div>
    
    <div id="toss-result" style="text-align: center; margin-bottom: 1rem; display: none;">
        <div style="background: var(--bg-secondary); padding: 0.75rem 1rem; border-radius: 8px; display: inline-block;">
            üé≤ <span id="toss-stats-text">Toss simulated per match</span>
        </div>
    </div>
    
    <div style="text-align: center; color: var(--text-muted); font-size: 0.875rem;">
        <span id="result-meta"></span>
    </div>
</div>

<!-- Scorecard Section (NN simulator only) - ESPN Cricinfo Style -->
<div id="scorecard-section" class="card" style="display: none; margin-top: 1.5rem;">
    <h2 class="card-title">Sample Scorecard</h2>
    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
        Representative match outcome based on simulation
    </p>
    
    <!-- Match Result Banner -->
    <div id="scorecard-result" style="text-align: center; padding: 1rem; margin-bottom: 1.5rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 8px; color: white;">
        <span style="font-size: 1.25rem; font-weight: 600;" id="scorecard-result-text"></span>
    </div>
    
    <!-- Innings Tabs -->
    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <button class="btn btn-primary" id="tab-inn1" onclick="showInnings(1)">1st Innings</button>
        <button class="btn" id="tab-inn2" onclick="showInnings(2)">2nd Innings</button>
    </div>
    
    <!-- First Innings Scorecard (ESPN Style) -->
    <div id="innings1-card">
        <!-- Team Header -->
        <div style="background: var(--accent-primary); color: white; padding: 0.75rem 1rem; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: 700; font-size: 1.1rem;" id="innings1-team-name">Team 1</span>
            <span style="font-weight: 700; font-size: 1.1rem;" id="innings1-total">0/0 (0 Ov)</span>
        </div>
        
        <!-- Batting Table -->
        <table class="espn-scorecard" style="width: 100%; border-collapse: collapse; margin-bottom: 0.5rem;">
            <thead>
                <tr style="background: var(--bg-tertiary); font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);">
                    <th style="text-align: left; padding: 0.5rem; width: 40%;">Batter</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">R</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">B</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">4s</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">6s</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">SR</th>
                </tr>
            </thead>
            <tbody id="innings1-batting"></tbody>
            <tfoot>
                <tr style="background: var(--bg-tertiary); font-size: 0.85rem;">
                    <td style="padding: 0.5rem; color: var(--text-muted);">Extras</td>
                    <td colspan="5" style="padding: 0.5rem; text-align: left;" id="innings1-extras">(lb 0, w 0, nb 0) 0</td>
                </tr>
                <tr style="background: var(--bg-secondary); font-weight: 700;">
                    <td style="padding: 0.75rem;">TOTAL</td>
                    <td colspan="5" style="padding: 0.75rem; text-align: left;" id="innings1-total-row">0 (0 wkts, 0 Ov)</td>
                </tr>
            </tfoot>
        </table>
        
        <!-- Bowling Header -->
        <div style="background: var(--bg-tertiary); padding: 0.5rem 1rem; margin-top: 1rem; border-radius: 8px 8px 0 0;">
            <span style="font-weight: 600; font-size: 0.9rem; color: var(--text-secondary);">BOWLING</span>
        </div>
        
        <!-- Bowling Table -->
        <table class="espn-scorecard" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: var(--bg-tertiary); font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);">
                    <th style="text-align: left; padding: 0.5rem; width: 40%;">Bowler</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">O</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">M</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">R</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">W</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">Econ</th>
                </tr>
            </thead>
            <tbody id="innings1-bowling"></tbody>
        </table>
    </div>
    
    <!-- Second Innings Scorecard (ESPN Style) -->
    <div id="innings2-card" style="display: none;">
        <!-- Team Header -->
        <div style="background: var(--accent-secondary); color: white; padding: 0.75rem 1rem; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: 700; font-size: 1.1rem;" id="innings2-team-name">Team 2</span>
            <span style="font-weight: 700; font-size: 1.1rem;" id="innings2-total">0/0 (0 Ov)</span>
        </div>
        <div style="background: var(--bg-secondary); padding: 0.5rem 1rem; font-size: 0.85rem; color: var(--text-muted);">
            Target: <span id="innings2-target" style="font-weight: 600; color: var(--text-primary);">-</span>
        </div>
        
        <!-- Batting Table -->
        <table class="espn-scorecard" style="width: 100%; border-collapse: collapse; margin-bottom: 0.5rem;">
            <thead>
                <tr style="background: var(--bg-tertiary); font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);">
                    <th style="text-align: left; padding: 0.5rem; width: 40%;">Batter</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">R</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">B</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">4s</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">6s</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">SR</th>
                </tr>
            </thead>
            <tbody id="innings2-batting"></tbody>
            <tfoot>
                <tr style="background: var(--bg-tertiary); font-size: 0.85rem;">
                    <td style="padding: 0.5rem; color: var(--text-muted);">Extras</td>
                    <td colspan="5" style="padding: 0.5rem; text-align: left;" id="innings2-extras">(lb 0, w 0, nb 0) 0</td>
                </tr>
                <tr style="background: var(--bg-secondary); font-weight: 700;">
                    <td style="padding: 0.75rem;">TOTAL</td>
                    <td colspan="5" style="padding: 0.75rem; text-align: left;" id="innings2-total-row">0 (0 wkts, 0 Ov)</td>
                </tr>
            </tfoot>
        </table>
        
        <!-- Bowling Header -->
        <div style="background: var(--bg-tertiary); padding: 0.5rem 1rem; margin-top: 1rem; border-radius: 8px 8px 0 0;">
            <span style="font-weight: 600; font-size: 0.9rem; color: var(--text-secondary);">BOWLING</span>
        </div>
        
        <!-- Bowling Table -->
        <table class="espn-scorecard" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: var(--bg-tertiary); font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);">
                    <th style="text-align: left; padding: 0.5rem; width: 40%;">Bowler</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">O</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">M</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">R</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">W</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">Econ</th>
                </tr>
            </thead>
            <tbody id="innings2-bowling"></tbody>
        </table>
    </div>
</div>

<!-- Loading with Progress -->
<div id="loading" class="card" style="display: none;">
    <h3 style="text-align: center; margin-bottom: 1rem;">Running Simulation...</h3>
    
    <!-- Progress Bar -->
    <div style="background: var(--bg-tertiary); border-radius: 8px; height: 24px; overflow: hidden; margin-bottom: 1rem;">
        <div id="progress-fill" style="height: 100%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); width: 0%; transition: width 0.3s ease;"></div>
    </div>
    
    <!-- Progress Stats -->
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; text-align: center;">
        <div>
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-primary);" id="progress-count">0</div>
            <div style="color: var(--text-muted); font-size: 0.75rem;">COMPLETED</div>
        </div>
        <div>
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);" id="progress-rate">--</div>
            <div style="color: var(--text-muted); font-size: 0.75rem;">SIMS/SEC</div>
        </div>
        <div>
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-secondary);" id="progress-eta">--</div>
            <div style="color: var(--text-muted); font-size: 0.75rem;">ETA (SEC)</div>
        </div>
    </div>
    
    <p style="text-align: center; color: var(--text-muted); margin-top: 1rem; font-size: 0.875rem;" id="progress-status">
        Initializing...
    </p>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Current gender selection
    let currentGender = 'male';
    let currentSeriesId = '';
    let currentSeriesName = '';
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadTeams();
        loadVenues();
        loadT20Series();  // Load series for match loader
    });
    
    function setGender(gender) {
        currentGender = gender;
        
        // Update button styles
        document.getElementById('gender-male').className = gender === 'male' ? 'btn btn-primary' : 'btn';
        document.getElementById('gender-female').className = gender === 'female' ? 'btn btn-primary' : 'btn';
        
        // Update loader title
        const genderText = gender === 'male' ? "Men's" : "Women's";
        document.getElementById('loader-title').textContent = `Load ${genderText} T20 Match`;
        
        // Reload series for the new gender
        loadT20Series();
        
        // Clear fixture select
        document.getElementById('fixture-select').innerHTML = '<option value="">-- Select a Match --</option>';
        document.getElementById('t20-match-info').style.display = 'none';
        
        // Reload teams and venues for new gender
        loadTeams();
        loadVenues();
        
        // Clear player selections
        ['team1-batters', 'team1-bowlers', 'team2-batters', 'team2-bowlers'].forEach(id => {
            document.getElementById(id).innerHTML = '';
        });
        ['team1-select', 'team2-select'].forEach(id => {
            document.getElementById(id).value = '';
        });
        
        // Update subtitle
        document.querySelector('.hero p').textContent = `Select teams and players to simulate ${genderText} T20 matches`;
    }
    
    // T20 Series and Match Loading Functions
    async function loadT20Series() {
        try {
            const response = await fetch(`/api/t20/series?gender=${currentGender}`);
            const data = await response.json();
            
            if (data.success) {
                const select = document.getElementById('series-select');
                select.innerHTML = '<option value="">-- Select Competition --</option>';
                
                data.series.forEach(series => {
                    const opt = document.createElement('option');
                    opt.value = series.id;
                    opt.dataset.name = series.name;
                    // Show series name with T20 count
                    opt.textContent = `${series.name} (${series.t20_count} matches)`;
                    select.appendChild(opt);
                });
                
                console.log(`Loaded ${data.series.length} ${currentGender} T20 series`);
            }
        } catch (error) {
            console.error('Error loading T20 series:', error);
        }
    }
    
    async function loadSeriesFixtures() {
        const seriesSelect = document.getElementById('series-select');
        const selectedOption = seriesSelect.selectedOptions[0];
        
        currentSeriesId = seriesSelect.value;
        currentSeriesName = selectedOption?.dataset?.name || '';
        
        if (!currentSeriesId) {
            document.getElementById('fixture-select').innerHTML = '<option value="">-- Select a Match --</option>';
            return;
        }
        
        try {
            const response = await fetch(`/api/t20/series/${currentSeriesId}/fixtures?days_ahead=14&series_name=${encodeURIComponent(currentSeriesName)}`);
            const data = await response.json();
            
            if (data.success) {
                const select = document.getElementById('fixture-select');
                select.innerHTML = '<option value="">-- Select a Match --</option>';
                
                if (data.fixtures.length === 0) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'No upcoming matches in next 14 days';
                    opt.disabled = true;
                    select.appendChild(opt);
                } else {
                    data.fixtures.forEach(fixture => {
                        const opt = document.createElement('option');
                        opt.value = fixture.id;
                        // Format: date - team1 vs team2
                        const team1Short = fixture.team1.replace(' Women', '').replace(' Men', '');
                        const team2Short = fixture.team2.replace(' Women', '').replace(' Men', '');
                        opt.textContent = `${fixture.date}: ${team1Short} vs ${team2Short}`;
                        if (fixture.has_squad) {
                            opt.textContent += ' ‚úì';
                        }
                        select.appendChild(opt);
                    });
                }
                
                console.log(`Loaded ${data.fixtures.length} fixtures for ${currentSeriesName}`);
            }
        } catch (error) {
            console.error('Error loading series fixtures:', error);
        }
    }
    
    async function loadT20Match() {
        const matchId = document.getElementById('fixture-select').value;
        if (!matchId) {
            alert('Please select a match first');
            return;
        }
        
        // Show loading
        document.getElementById('t20-loading').style.display = 'block';
        document.getElementById('t20-match-info').style.display = 'none';
        
        try {
            const response = await fetch(`/api/t20/match/${matchId}`);
            const data = await response.json();
            
            document.getElementById('t20-loading').style.display = 'none';
            
            if (data.success && data.match) {
                const match = data.match;
                
                // Show match info
                document.getElementById('t20-match-name').textContent = `${match.team1_db_name} vs ${match.team2_db_name}`;
                document.getElementById('t20-match-date').textContent = match.date;
                
                const matched1 = match.team1_squad.filter(p => p.matched).length;
                const matched2 = match.team2_squad.filter(p => p.matched).length;
                document.getElementById('t20-team1-info').textContent = `${matched1}/${match.team1_squad.length} players`;
                document.getElementById('t20-team2-info').textContent = `${matched2}/${match.team2_squad.length} players`;
                document.getElementById('t20-match-info').style.display = 'block';
                
                // Auto-fill teams
                await autoFillTeam(1, match.team1_db_name, match.team1_squad, match.team1_suggested_xi);
                await autoFillTeam(2, match.team2_db_name, match.team2_squad, match.team2_suggested_xi);
                
                // Auto-select venue if we found a match
                if (match.venue_db_id) {
                    const venueSelect = document.getElementById('venue-select');
                    venueSelect.value = match.venue_db_id;
                    console.log(`Auto-selected venue: ${match.venue_db_name} (ID: ${match.venue_db_id})`);
                }
                
                // Enable toss simulation for upcoming matches (it's more realistic)
                document.getElementById('use-toss').checked = true;
                
            } else if (data.error === 'no_squad') {
                // Squad data not available - help user select teams manually
                const info = data.match_info;
                const msg = `‚ö†Ô∏è Squad data not available for this match.\n\n` +
                    `Teams: ${info.team1_name} vs ${info.team2_name}\n` +
                    `Venue: ${info.venue}\n\n` +
                    `Please select the teams manually from the dropdowns below.`;
                alert(msg);
                
                // Show match info with what we know
                document.getElementById('t20-match-name').textContent = `${info.team1_name} vs ${info.team2_name}`;
                document.getElementById('t20-match-date').textContent = info.date;
                document.getElementById('t20-team1-info').textContent = 'Select manually';
                document.getElementById('t20-team2-info').textContent = 'Select manually';
                document.getElementById('t20-match-info').style.display = 'block';
                
            } else {
                alert('Error loading match: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            document.getElementById('t20-loading').style.display = 'none';
            console.error('Error loading T20 match:', error);
            alert('Error loading match data');
        }
    }
    
    // Legacy WBBL functions (kept for backward compatibility)
    async function loadWBBLFixtures() {
        // Redirect to the new series-based loader
        console.log('Legacy loadWBBLFixtures called - use loadT20Series instead');
    }
    
    async function loadWBBLMatch() {
        // Redirect to the new T20 loader
        console.log('Legacy loadWBBLMatch called - use loadT20Match instead');
    }
    
    async function autoFillTeam(teamNum, teamName, squad, suggestedXI) {
        // Find and select the team
        const teamSelect = document.getElementById(`team${teamNum}-select`);
        for (let opt of teamSelect.options) {
            if (opt.textContent === teamName) {
                teamSelect.value = opt.value;
                break;
            }
        }
        
        // Load players for this team
        await loadPlayers(teamNum);
        
        // Small delay to ensure DOM is updated
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Select the suggested XI in batters list
        const battersSelect = document.getElementById(`team${teamNum}-batters`);
        const bowlersSelect = document.getElementById(`team${teamNum}-bowlers`);
        
        // Clear current selections
        for (let opt of battersSelect.options) opt.selected = false;
        for (let opt of bowlersSelect.options) opt.selected = false;
        
        // Select suggested players
        let battersSelected = 0;
        let bowlersSelected = 0;
        
        for (let playerId of suggestedXI) {
            // Try to select in batters list
            for (let opt of battersSelect.options) {
                if (parseInt(opt.value) === playerId && battersSelected < 11) {
                    opt.selected = true;
                    battersSelected++;
                    break;
                }
            }
            
            // Also try bowlers list
            for (let opt of bowlersSelect.options) {
                if (parseInt(opt.value) === playerId && bowlersSelected < 5) {
                    opt.selected = true;
                    bowlersSelected++;
                }
            }
        }
        
        console.log(`Team ${teamNum}: Selected ${battersSelected} batters, ${bowlersSelected} bowlers`);
    }
    
    async function loadTeams() {
        try {
            const response = await fetch(`/api/teams?gender=${currentGender}`);
            const data = await response.json();
            
            if (data.success) {
                ['team1-select', 'team2-select'].forEach(selectId => {
                    const select = document.getElementById(selectId);
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">-- Select Team --</option>';
                    data.teams.forEach(team => {
                        const opt = document.createElement('option');
                        opt.value = team.team_id;
                        opt.textContent = team.name;
                        select.appendChild(opt);
                    });
                    select.value = currentValue;
                });
            }
        } catch (error) {
            console.error('Error loading teams:', error);
        }
    }
    
    async function loadVenues() {
        try {
            const response = await fetch(`/api/venues?gender=${currentGender}`);
            const data = await response.json();
            
            if (data.success) {
                const venueSelect = document.getElementById('venue-select');
                venueSelect.innerHTML = '<option value="">-- Neutral Venue --</option>';
                data.venues.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.venue_id;
                    opt.textContent = `${v.name}${v.city ? ', ' + v.city : ''} (${v.match_count} matches)`;
                    venueSelect.appendChild(opt);
                });
            }
        } catch (error) {
            console.error('Error loading venues:', error);
        }
    }
    
    async function loadPlayers(teamNum) {
        const teamId = document.getElementById(`team${teamNum}-select`).value;
        if (!teamId) return;
        
        const response = await fetch(`/api/players/${teamId}?gender=${currentGender}`);
        const data = await response.json();
        
        if (data.success) {
            // Populate batters
            const battersSelect = document.getElementById(`team${teamNum}-batters`);
            battersSelect.innerHTML = '';
            data.batters.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.player_id;
                opt.textContent = `${p.name} (${p.total_runs} runs)`;
                battersSelect.appendChild(opt);
            });
            
            // Populate bowlers
            const bowlersSelect = document.getElementById(`team${teamNum}-bowlers`);
            bowlersSelect.innerHTML = '';
            data.bowlers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.player_id;
                opt.textContent = `${p.name} (${p.total_wickets} wkts)`;
                bowlersSelect.appendChild(opt);
            });
            
            // Auto-select top players
            selectTop(battersSelect, 11);
            selectTop(bowlersSelect, 5);
        }
    }
    
    function selectTop(selectEl, n) {
        const options = selectEl.options;
        for (let i = 0; i < Math.min(n, options.length); i++) {
            options[i].selected = true;
        }
    }
    
    function getSelectedValues(selectId) {
        const select = document.getElementById(selectId);
        return Array.from(select.selectedOptions).map(opt => parseInt(opt.value));
    }
    
    async function runSimulation() {
        const team1Name = document.getElementById('team1-select').selectedOptions[0]?.text || 'Team 1';
        const team2Name = document.getElementById('team2-select').selectedOptions[0]?.text || 'Team 2';
        
        const team1Batters = getSelectedValues('team1-batters');
        const team1Bowlers = getSelectedValues('team1-bowlers');
        const team2Batters = getSelectedValues('team2-batters');
        const team2Bowlers = getSelectedValues('team2-bowlers');
        
        if (team1Batters.length === 0 || team2Batters.length === 0) {
            alert('Please select players for both teams');
            return;
        }
        
        // Deduplicate batters (each player can only bat once!)
        const uniqueTeam1Batters = [...new Set(team1Batters)];
        const uniqueTeam2Batters = [...new Set(team2Batters)];
        
        if (uniqueTeam1Batters.length < team1Batters.length) {
            console.warn(`Removed ${team1Batters.length - uniqueTeam1Batters.length} duplicate Team 1 batters`);
        }
        if (uniqueTeam2Batters.length < team2Batters.length) {
            console.warn(`Removed ${team2Batters.length - uniqueTeam2Batters.length} duplicate Team 2 batters`);
        }
        
        // Get venue and toss options
        const venueSelect = document.getElementById('venue-select');
        const venueId = venueSelect.value ? parseInt(venueSelect.value) : null;
        const useToss = document.getElementById('use-toss').checked;
        const nSimulations = parseInt(document.getElementById('n-simulations').value);
        
        // Show loading with progress
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results').style.display = 'none';
        document.getElementById('scorecard-section').style.display = 'none';
        
        // Reset progress UI
        document.getElementById('progress-fill').style.width = '0%';
        document.getElementById('progress-count').textContent = '0';
        document.getElementById('progress-rate').textContent = '--';
        document.getElementById('progress-eta').textContent = '--';
        document.getElementById('progress-status').textContent = `Starting ${nSimulations.toLocaleString()} simulations...`;
        
        // Smooth animation state
        let displayedCount = 0;
        let targetCount = 0;
        let currentRate = 100; // Default estimate: 100 sims/sec
        let animationInterval = null;
        let simulationComplete = false;
        
        // Start smooth animation loop (updates every 50ms)
        animationInterval = setInterval(() => {
            if (simulationComplete) {
                clearInterval(animationInterval);
                return;
            }
            
            // Smoothly increment towards target
            if (displayedCount < targetCount) {
                // Increment based on estimated rate
                const increment = currentRate / 20; // 50ms = 1/20 second
                displayedCount = Math.min(displayedCount + increment, targetCount);
                
                const pct = (displayedCount / nSimulations) * 100;
                const eta = currentRate > 0 ? (nSimulations - displayedCount) / currentRate : 0;
                
                document.getElementById('progress-fill').style.width = pct.toFixed(1) + '%';
                document.getElementById('progress-count').textContent = Math.round(displayedCount).toLocaleString();
                document.getElementById('progress-rate').textContent = Math.round(currentRate).toLocaleString();
                document.getElementById('progress-eta').textContent = eta.toFixed(1);
                document.getElementById('progress-status').textContent = 
                    `${Math.round(displayedCount).toLocaleString()} / ${nSimulations.toLocaleString()} simulations (${pct.toFixed(1)}%)`;
            }
        }, 50);
        
        const payload = {
            team1_batters: uniqueTeam1Batters,
            team1_bowlers: team1Bowlers,
            team2_batters: uniqueTeam2Batters,
            team2_bowlers: team2Bowlers,
            simulator: document.getElementById('simulator-type').value,
            n_simulations: nSimulations,
            venue_id: venueId,
            use_toss: useToss,
            gender: currentGender
        };
        
        try {
            // Use streaming endpoint for progress updates
            const response = await fetch('/api/simulate-stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                
                // Process complete SSE messages
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line in buffer
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.type === 'progress') {
                                // Update targets for smooth animation
                                targetCount = data.completed;
                                currentRate = data.rate;
                                // Animation loop will smoothly update the UI
                            }
                            else if (data.type === 'result') {
                                // Stop animation and show final results
                                simulationComplete = true;
                                clearInterval(animationInterval);
                                
                                // Ensure progress shows 100%
                                document.getElementById('progress-fill').style.width = '100%';
                                document.getElementById('progress-count').textContent = nSimulations.toLocaleString();
                                
                                // Small delay to show 100% before hiding
                                setTimeout(() => {
                                    document.getElementById('loading').style.display = 'none';
                                    displayResults(data, team1Name, team2Name);
                                }, 300);
                            }
                            else if (data.type === 'error') {
                                simulationComplete = true;
                                clearInterval(animationInterval);
                                document.getElementById('loading').style.display = 'none';
                                alert('Error: ' + data.error);
                            }
                        } catch (e) {
                            console.error('Error parsing SSE data:', e);
                        }
                    }
                }
            }
        } catch (error) {
            document.getElementById('loading').style.display = 'none';
            alert('Error running simulation: ' + error.message);
        }
    }
    
    function displayResults(data, team1Name, team2Name) {
        // Update results
        document.getElementById('result-team1-name').textContent = team1Name;
        document.getElementById('result-team2-name').textContent = team2Name;
        
        document.getElementById('result-team1-prob').textContent = data.team1_win_prob + '%';
        document.getElementById('result-team2-prob').textContent = data.team2_win_prob + '%';
        
        document.getElementById('result-team1-bar').style.width = data.team1_win_prob + '%';
        document.getElementById('result-team2-bar').style.width = data.team2_win_prob + '%';
        
        document.getElementById('result-team1-score').textContent = data.avg_team1_score;
        document.getElementById('result-team2-score').textContent = data.avg_team2_score;
        
        document.getElementById('result-team1-range').textContent = 
            `${data.team1_score_range[0]} - ${data.team1_score_range[1]}`;
        document.getElementById('result-team2-range').textContent = 
            `${data.team2_score_range[0]} - ${data.team2_score_range[1]}`;
        
        // Show toss info if available (now shows per-simulation statistics)
        const tossResult = document.getElementById('toss-result');
        if (data.toss_info) {
            const ti = data.toss_info;
            document.getElementById('toss-stats-text').textContent = 
                `Toss: Team 1 won ${ti.team1_won_toss_pct}% | Elected to field ${ti.chose_field_pct}% | Team 1 batted first ${ti.team1_batted_first_pct}%`;
            tossResult.style.display = 'block';
        } else {
            tossResult.style.display = 'none';
        }
        
        // Build meta string
        let meta = `${data.n_simulations.toLocaleString()} simulations using ${data.simulator === 'nn' ? 'Neural Network' : 'Fast Lookup'} engine in ${data.elapsed_ms.toFixed(0)}ms`;
        if (data.h2h_rate !== null && data.h2h_rate !== undefined) {
            meta += ` | H2H data used: ${data.h2h_rate}%`;
        }
        if (data.venue_id) {
            meta += ` | Venue #${data.venue_id}`;
        }
        document.getElementById('result-meta').textContent = meta;
        
        document.getElementById('results').style.display = 'block';
        
        // Display scorecard if available (NN simulator only)
        const scorecardSection = document.getElementById('scorecard-section');
        if (data.scorecard) {
            displayScorecard(data.scorecard, team1Name, team2Name);
            scorecardSection.style.display = 'block';
        } else {
            scorecardSection.style.display = 'none';
        }
    }
    
    function showInnings(inningsNum) {
        // Update tabs
        document.getElementById('tab-inn1').className = inningsNum === 1 ? 'btn btn-primary' : 'btn';
        document.getElementById('tab-inn2').className = inningsNum === 2 ? 'btn btn-primary' : 'btn';
        
        // Show/hide innings cards
        document.getElementById('innings1-card').style.display = inningsNum === 1 ? 'block' : 'none';
        document.getElementById('innings2-card').style.display = inningsNum === 2 ? 'block' : 'none';
    }
    
    function displayScorecard(scorecard, team1Name, team2Name) {
        // Helper to format overs
        const formatOvers = (overs) => {
            const fullOvers = Math.floor(overs);
            const balls = Math.round((overs % 1) * 10);
            return balls > 0 ? `${fullOvers}.${balls}` : `${fullOvers}`;
        };
        
        // Helper to format dismissal ESPN-style
        const formatDismissal = (b, bowlers) => {
            if (b.dismissal === 'not out') {
                return '<span style="color: var(--accent-green); font-weight: 500;">not out</span>';
            }
            // Find bowler name
            const bowlerName = bowlers.find(bl => bl.player_id === b.dismissed_by)?.name || 'Unknown';
            const shortBowlerName = bowlerName.split(' ').pop(); // Last name only
            return `<span style="color: var(--text-muted);">b ${shortBowlerName}</span>`;
        };
        
        // Result banner
        document.getElementById('scorecard-result-text').textContent = scorecard.result
            .replace('Team 1', team1Name)
            .replace('Team 2', team2Name);
        
        // ========== FIRST INNINGS ==========
        document.getElementById('innings1-team-name').textContent = team1Name + ' Innings';
        const overs1 = formatOvers(scorecard.team1_overs);
        document.getElementById('innings1-total').textContent = 
            `${scorecard.team1_total}/${scorecard.team1_wickets} (${overs1} Ov)`;
        
        // Calculate extras (estimate - total minus sum of individual runs)
        const battingRuns1 = scorecard.team1_batting.reduce((sum, b) => sum + b.runs, 0);
        const extras1 = Math.max(0, scorecard.team1_total - battingRuns1);
        document.getElementById('innings1-extras').textContent = `(b 0, lb 0, w ${extras1}, nb 0) ${extras1}`;
        document.getElementById('innings1-total-row').textContent = 
            `${scorecard.team1_total} (${scorecard.team1_wickets} wkts, ${overs1} Ov)`;
        
        // First innings batting
        const batting1 = document.getElementById('innings1-batting');
        batting1.innerHTML = '';
        scorecard.team1_batting.filter(b => b.balls > 0 || b.dismissal !== 'not out').forEach(b => {
            batting1.innerHTML += `
                <tr style="border-bottom: 1px solid var(--bg-tertiary);">
                    <td style="text-align: left; padding: 0.5rem;">
                        <div style="font-weight: 500;">${b.name || 'Player ' + b.player_id}</div>
                        <div style="font-size: 0.75rem;">${formatDismissal(b, scorecard.team2_bowling)}</div>
                    </td>
                    <td style="text-align: center; padding: 0.5rem; font-weight: 700;">${b.runs}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.balls}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.fours}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.sixes}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.strike_rate}</td>
                </tr>
            `;
        });
        
        // First innings bowling (Team 2's bowlers)
        const bowling1 = document.getElementById('innings1-bowling');
        bowling1.innerHTML = '';
        scorecard.team2_bowling.filter(b => b.balls > 0).forEach(b => {
            bowling1.innerHTML += `
                <tr style="border-bottom: 1px solid var(--bg-tertiary);">
                    <td style="text-align: left; padding: 0.5rem; font-weight: 500;">${b.name || 'Player ' + b.player_id}</td>
                    <td style="text-align: center; padding: 0.5rem;">${b.overs}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">0</td>
                    <td style="text-align: center; padding: 0.5rem;">${b.runs}</td>
                    <td style="text-align: center; padding: 0.5rem; font-weight: 700; color: ${b.wickets > 0 ? 'var(--accent-green)' : 'inherit'};">${b.wickets}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.economy}</td>
                </tr>
            `;
        });
        
        // ========== SECOND INNINGS ==========
        document.getElementById('innings2-team-name').textContent = team2Name + ' Innings';
        const overs2 = formatOvers(scorecard.team2_overs);
        document.getElementById('innings2-total').textContent = 
            `${scorecard.team2_total}/${scorecard.team2_wickets} (${overs2} Ov)`;
        document.getElementById('innings2-target').textContent = scorecard.target;
        
        // Calculate extras
        const battingRuns2 = scorecard.team2_batting.reduce((sum, b) => sum + b.runs, 0);
        const extras2 = Math.max(0, scorecard.team2_total - battingRuns2);
        document.getElementById('innings2-extras').textContent = `(b 0, lb 0, w ${extras2}, nb 0) ${extras2}`;
        document.getElementById('innings2-total-row').textContent = 
            `${scorecard.team2_total} (${scorecard.team2_wickets} wkts, ${overs2} Ov)`;
        
        // Second innings batting
        const batting2 = document.getElementById('innings2-batting');
        batting2.innerHTML = '';
        scorecard.team2_batting.filter(b => b.balls > 0 || b.dismissal !== 'not out').forEach(b => {
            batting2.innerHTML += `
                <tr style="border-bottom: 1px solid var(--bg-tertiary);">
                    <td style="text-align: left; padding: 0.5rem;">
                        <div style="font-weight: 500;">${b.name || 'Player ' + b.player_id}</div>
                        <div style="font-size: 0.75rem;">${formatDismissal(b, scorecard.team1_bowling)}</div>
                    </td>
                    <td style="text-align: center; padding: 0.5rem; font-weight: 700;">${b.runs}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.balls}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.fours}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.sixes}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.strike_rate}</td>
                </tr>
            `;
        });
        
        // Second innings bowling (Team 1's bowlers)
        const bowling2 = document.getElementById('innings2-bowling');
        bowling2.innerHTML = '';
        scorecard.team1_bowling.filter(b => b.balls > 0).forEach(b => {
            bowling2.innerHTML += `
                <tr style="border-bottom: 1px solid var(--bg-tertiary);">
                    <td style="text-align: left; padding: 0.5rem; font-weight: 500;">${b.name || 'Player ' + b.player_id}</td>
                    <td style="text-align: center; padding: 0.5rem;">${b.overs}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">0</td>
                    <td style="text-align: center; padding: 0.5rem;">${b.runs}</td>
                    <td style="text-align: center; padding: 0.5rem; font-weight: 700; color: ${b.wickets > 0 ? 'var(--accent-green)' : 'inherit'};">${b.wickets}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.economy}</td>
                </tr>
            `;
        });
        
        // Show first innings by default
        showInnings(1);
    }
</script>
{% endblock %}
