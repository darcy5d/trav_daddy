{% extends "base.html" %}

{% block title %}Match Prediction - Cricket Predictor{% endblock %}

{% block navbar_extra %}
<div class="timezone-selector">
    <label for="timezone-select">üïê TZ:</label>
    <select id="timezone-select" onchange="setTimezone(this.value)">
        <option value="Australia/Melbourne">Melbourne (AEDT)</option>
        <option value="Australia/Sydney">Sydney (AEDT)</option>
        <option value="Asia/Kolkata">India (IST)</option>
        <option value="Asia/Dubai">Dubai (GST)</option>
        <option value="Europe/London">London (GMT)</option>
        <option value="America/New_York">New York (EST)</option>
        <option value="UTC">UTC/GMT</option>
    </select>
</div>
{% endblock %}

{% block content %}
<style>
    /* Segmented Control Styles */
    .segmented-control {
        display: flex;
        background: var(--bg-tertiary);
        border-radius: 8px;
        padding: 4px;
        gap: 4px;
        margin-bottom: 0.75rem;
    }
    
    .segmented-control button {
        flex: 1;
        padding: 0.5rem 1rem;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .segmented-control button:hover {
        color: var(--text-primary);
        background: rgba(255, 255, 255, 0.05);
    }
    
    .segmented-control button.active {
        background: var(--accent-primary);
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .segmented-control.secondary button.active {
        background: var(--accent-secondary);
    }
    
    .team-filter-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
        display: block;
    }
    
    /* Timezone Selector (in navbar) */
    .timezone-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .timezone-selector label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .timezone-selector select {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 0.35rem 0.5rem;
        font-size: 0.85rem;
        cursor: pointer;
    }
    
    .timezone-selector select:focus {
        outline: none;
        border-color: var(--accent-primary);
    }
</style>

<div class="hero" style="padding: 2rem;">
    <h1>Match Prediction</h1>
    <p>Select an upcoming match or manually configure teams to simulate</p>
</div>

<!-- Upcoming Matches (Next 24 Hours) -->
<div id="upcoming-matches" class="card" style="margin-bottom: 1.5rem; border: 2px solid var(--accent-primary);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 class="card-title" style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.5rem;">üèè</span> Upcoming Matches
        </h2>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button class="btn" onclick="loadUpcomingMatches(true)" style="padding: 0.5rem 1rem;">
                üîÑ Refresh
            </button>
            <button class="btn" id="prefetch-btn" onclick="prefetchAllMatches()" style="padding: 0.5rem 1rem;">
                üì• Pre-fetch Data
            </button>
            <span id="prefetch-status" style="font-size: 0.8rem; color: var(--text-muted);"></span>
        </div>
    </div>
    
    <!-- Data Source Toggle -->
    <div style="margin-bottom: 1rem;">
        <span class="team-filter-label">Data Source</span>
        <div class="segmented-control" id="data-source-control">
            <button class="active" data-value="espn" onclick="setDataSource('espn')">ESPN Cricinfo (All T20s)</button>
            <button data-value="api" onclick="setDataSource('api')">Cricket Data API</button>
        </div>
        <small id="source-info" style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
            ESPN Cricinfo provides comprehensive coverage of all T20 matches worldwide
        </small>
    </div>
    
    <div id="matches-loading" style="text-align: center; padding: 2rem;">
        <div class="spinner" style="margin: 0 auto;"></div>
        <p style="color: var(--text-secondary); margin-top: 0.5rem;">Loading upcoming matches...</p>
    </div>
    
    <div id="matches-list" style="display: none;">
        <!-- Matches will be populated here by JavaScript -->
    </div>
    
    <div id="matches-empty" style="display: none; text-align: center; padding: 2rem; color: var(--text-secondary);">
        <p>No matches scheduled in the next 24 hours.</p>
        <p style="font-size: 0.875rem; margin-top: 0.5rem;">You can still manually select teams below.</p>
    </div>
    
    <div id="t20-match-info" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <strong id="t20-match-name"></strong>
            <span id="t20-match-date" style="color: var(--text-muted);"></span>
        </div>
        <div style="font-size: 0.875rem; color: var(--text-secondary);">
            <span id="t20-team1-info"></span> vs <span id="t20-team2-info"></span>
        </div>
    </div>
</div>

<!-- Hidden elements for match loading -->
<div id="t20-loading" style="display: none; text-align: center; padding: 1rem;">
    <div class="spinner" style="margin: 0 auto;"></div>
    <p style="color: var(--text-secondary); margin-top: 0.5rem;">Loading match data...</p>
</div>

<div class="grid grid-2">
    <!-- Team 1 Selection -->
    <div class="card">
        <h2 class="card-title" style="color: var(--accent-primary);">Team 1</h2>
        
        <!-- Gender Filter -->
        <span class="team-filter-label">Gender</span>
        <div class="segmented-control" id="team1-gender-control">
            <button class="active" data-value="male" onclick="setTeamFilter(1, 'gender', 'male')">Men's</button>
            <button data-value="female" onclick="setTeamFilter(1, 'gender', 'female')">Women's</button>
        </div>
        
        <!-- Type Filter -->
        <span class="team-filter-label">Team Type</span>
        <div class="segmented-control secondary" id="team1-type-control">
            <button class="active" data-value="all" onclick="setTeamFilter(1, 'type', 'all')">All</button>
            <button data-value="international" onclick="setTeamFilter(1, 'type', 'international')">International</button>
            <button data-value="club" onclick="setTeamFilter(1, 'type', 'club')">Club / Domestic</button>
        </div>
        
        <div class="form-group">
            <label>Select Team <span id="team1-count" style="color: var(--text-muted); font-weight: normal;"></span></label>
            <select id="team1-select" onchange="loadPlayers(1)">
                <option value="">-- Select Team --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Batters (select 11)</label>
            <select id="team1-batters" multiple size="8" style="min-height: 200px;">
            </select>
            <small style="color: var(--text-muted);">Hold Ctrl/Cmd to select multiple</small>
        </div>
        
        <div class="form-group">
            <label>Bowlers (select 5)</label>
            <select id="team1-bowlers" multiple size="5" style="min-height: 120px;">
            </select>
        </div>
    </div>
    
    <!-- Team 2 Selection -->
    <div class="card">
        <h2 class="card-title" style="color: var(--accent-secondary);">Team 2</h2>
        
        <!-- Gender Filter -->
        <span class="team-filter-label">Gender</span>
        <div class="segmented-control secondary" id="team2-gender-control">
            <button class="active" data-value="male" onclick="setTeamFilter(2, 'gender', 'male')">Men's</button>
            <button data-value="female" onclick="setTeamFilter(2, 'gender', 'female')">Women's</button>
        </div>
        
        <!-- Type Filter -->
        <span class="team-filter-label">Team Type</span>
        <div class="segmented-control secondary" id="team2-type-control">
            <button class="active" data-value="all" onclick="setTeamFilter(2, 'type', 'all')">All</button>
            <button data-value="international" onclick="setTeamFilter(2, 'type', 'international')">International</button>
            <button data-value="club" onclick="setTeamFilter(2, 'type', 'club')">Club / Domestic</button>
        </div>
        
        <div class="form-group">
            <label>Select Team <span id="team2-count" style="color: var(--text-muted); font-weight: normal;"></span></label>
            <select id="team2-select" onchange="loadPlayers(2)">
                <option value="">-- Select Team --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Batters (select 11)</label>
            <select id="team2-batters" multiple size="8" style="min-height: 200px;">
            </select>
            <small style="color: var(--text-muted);">Hold Ctrl/Cmd to select multiple</small>
        </div>
        
        <div class="form-group">
            <label>Bowlers (select 5)</label>
            <select id="team2-bowlers" multiple size="5" style="min-height: 120px;">
            </select>
        </div>
    </div>
</div>

<!-- Venue Selection -->
<div class="card">
    <h2 class="card-title">Match Conditions</h2>
    <div class="grid grid-2">
        <div class="form-group">
            <label>Venue (affects scoring patterns)</label>
            <select id="venue-select">
                <option value="">-- Neutral Venue --</option>
            </select>
            <small style="color: var(--text-muted);" id="venue-info"></small>
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="use-toss" style="width: auto;">
                Simulate Toss
            </label>
            <small style="color: var(--text-muted);">Uses historical bat/field preferences (T20: 55% elect to field)</small>
        </div>
    </div>
</div>

<!-- Simulation Options -->
<div class="card">
    <h2 class="card-title">Simulation Options</h2>
    <div class="grid grid-3">
        <div class="form-group">
            <label>Simulator Engine</label>
            <select id="simulator-type">
                <option value="fast">Fast Lookup (0.1ms/match)</option>
                <option value="nn" selected>Neural Network (5ms/match) + Scorecard</option>
            </select>
        </div>
        <div class="form-group">
            <label>Number of Simulations</label>
            <input type="number" id="n-simulations" value="1000" min="100" max="10000" step="100">
        </div>
        <div class="form-group">
            <label>&nbsp;</label>
            <button class="btn btn-primary" onclick="runSimulation()" style="width: 100%;">
                Run Simulation
            </button>
        </div>
    </div>
</div>

<!-- Results -->
<div id="results" class="card" style="display: none;">
    <h2 class="card-title">Prediction Results</h2>
    
    <div class="grid grid-2" style="margin-bottom: 2rem;">
        <!-- Team 1 Result -->
        <div style="text-align: center; padding: 2rem; background: var(--bg-tertiary); border-radius: 12px;">
            <div style="font-size: 1.25rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                <span id="result-team1-name">Team 1</span>
            </div>
            <div class="stat-value" style="color: var(--accent-primary);" id="result-team1-prob">--%</div>
            <div class="probability-bar">
                <div class="probability-fill" id="result-team1-bar" style="background: var(--accent-primary); width: 0%;"></div>
            </div>
            <div style="margin-top: 1rem; color: var(--text-secondary);">
                Avg Score: <span id="result-team1-score">--</span>
            </div>
            <div style="color: var(--text-muted); font-size: 0.875rem;">
                Range: <span id="result-team1-range">-- - --</span>
            </div>
        </div>
        
        <!-- Team 2 Result -->
        <div style="text-align: center; padding: 2rem; background: var(--bg-tertiary); border-radius: 12px;">
            <div style="font-size: 1.25rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                <span id="result-team2-name">Team 2</span>
            </div>
            <div class="stat-value" style="color: var(--accent-secondary);" id="result-team2-prob">--%</div>
            <div class="probability-bar">
                <div class="probability-fill" id="result-team2-bar" style="background: var(--accent-secondary); width: 0%;"></div>
            </div>
            <div style="margin-top: 1rem; color: var(--text-secondary);">
                Avg Score: <span id="result-team2-score">--</span>
            </div>
            <div style="color: var(--text-muted); font-size: 0.875rem;">
                Range: <span id="result-team2-range">-- - --</span>
            </div>
        </div>
    </div>
    
    <div id="toss-result" style="text-align: center; margin-bottom: 1rem; display: none;">
        <div style="background: var(--bg-secondary); padding: 0.75rem 1rem; border-radius: 8px; display: inline-block;">
            üé≤ <span id="toss-stats-text">Toss simulated per match</span>
        </div>
    </div>
    
    <div style="text-align: center; color: var(--text-muted); font-size: 0.875rem;">
        <span id="result-meta"></span>
    </div>
</div>

<!-- Scorecard Section (NN simulator only) - ESPN Cricinfo Style -->
<div id="scorecard-section" class="card" style="display: none; margin-top: 1.5rem;">
    <h2 class="card-title">Sample Scorecard</h2>
    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
        Representative match outcome based on simulation
    </p>
    
    <!-- Match Result Banner -->
    <div id="scorecard-result" style="text-align: center; padding: 1rem; margin-bottom: 1.5rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 8px; color: white;">
        <span style="font-size: 1.25rem; font-weight: 600;" id="scorecard-result-text"></span>
    </div>
    
    <!-- Innings Tabs -->
    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <button class="btn btn-primary" id="tab-inn1" onclick="showInnings(1)">1st Innings</button>
        <button class="btn" id="tab-inn2" onclick="showInnings(2)">2nd Innings</button>
    </div>
    
    <!-- First Innings Scorecard (ESPN Style) -->
    <div id="innings1-card">
        <!-- Team Header -->
        <div style="background: var(--accent-primary); color: white; padding: 0.75rem 1rem; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: 700; font-size: 1.1rem;" id="innings1-team-name">Team 1</span>
            <span style="font-weight: 700; font-size: 1.1rem;" id="innings1-total">0/0 (0 Ov)</span>
        </div>
        
        <!-- Batting Table -->
        <table class="espn-scorecard" style="width: 100%; border-collapse: collapse; margin-bottom: 0.5rem;">
            <thead>
                <tr style="background: var(--bg-tertiary); font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);">
                    <th style="text-align: left; padding: 0.5rem; width: 40%;">Batter</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">R</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">B</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">4s</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">6s</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">SR</th>
                </tr>
            </thead>
            <tbody id="innings1-batting"></tbody>
            <tfoot>
                <tr style="background: var(--bg-tertiary); font-size: 0.85rem;">
                    <td style="padding: 0.5rem; color: var(--text-muted);">Extras</td>
                    <td colspan="5" style="padding: 0.5rem; text-align: left;" id="innings1-extras">(lb 0, w 0, nb 0) 0</td>
                </tr>
                <tr style="background: var(--bg-secondary); font-weight: 700;">
                    <td style="padding: 0.75rem;">TOTAL</td>
                    <td colspan="5" style="padding: 0.75rem; text-align: left;" id="innings1-total-row">0 (0 wkts, 0 Ov)</td>
                </tr>
            </tfoot>
        </table>
        
        <!-- Bowling Header -->
        <div style="background: var(--bg-tertiary); padding: 0.5rem 1rem; margin-top: 1rem; border-radius: 8px 8px 0 0;">
            <span style="font-weight: 600; font-size: 0.9rem; color: var(--text-secondary);">BOWLING</span>
        </div>
        
        <!-- Bowling Table -->
        <table class="espn-scorecard" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: var(--bg-tertiary); font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);">
                    <th style="text-align: left; padding: 0.5rem; width: 40%;">Bowler</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">O</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">M</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">R</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">W</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">Econ</th>
                </tr>
            </thead>
            <tbody id="innings1-bowling"></tbody>
        </table>
    </div>
    
    <!-- Second Innings Scorecard (ESPN Style) -->
    <div id="innings2-card" style="display: none;">
        <!-- Team Header -->
        <div style="background: var(--accent-secondary); color: white; padding: 0.75rem 1rem; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: 700; font-size: 1.1rem;" id="innings2-team-name">Team 2</span>
            <span style="font-weight: 700; font-size: 1.1rem;" id="innings2-total">0/0 (0 Ov)</span>
        </div>
        <div style="background: var(--bg-secondary); padding: 0.5rem 1rem; font-size: 0.85rem; color: var(--text-muted);">
            Target: <span id="innings2-target" style="font-weight: 600; color: var(--text-primary);">-</span>
        </div>
        
        <!-- Batting Table -->
        <table class="espn-scorecard" style="width: 100%; border-collapse: collapse; margin-bottom: 0.5rem;">
            <thead>
                <tr style="background: var(--bg-tertiary); font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);">
                    <th style="text-align: left; padding: 0.5rem; width: 40%;">Batter</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">R</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">B</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">4s</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">6s</th>
                    <th style="text-align: center; padding: 0.5rem; width: 8%;">SR</th>
                </tr>
            </thead>
            <tbody id="innings2-batting"></tbody>
            <tfoot>
                <tr style="background: var(--bg-tertiary); font-size: 0.85rem;">
                    <td style="padding: 0.5rem; color: var(--text-muted);">Extras</td>
                    <td colspan="5" style="padding: 0.5rem; text-align: left;" id="innings2-extras">(lb 0, w 0, nb 0) 0</td>
                </tr>
                <tr style="background: var(--bg-secondary); font-weight: 700;">
                    <td style="padding: 0.75rem;">TOTAL</td>
                    <td colspan="5" style="padding: 0.75rem; text-align: left;" id="innings2-total-row">0 (0 wkts, 0 Ov)</td>
                </tr>
            </tfoot>
        </table>
        
        <!-- Bowling Header -->
        <div style="background: var(--bg-tertiary); padding: 0.5rem 1rem; margin-top: 1rem; border-radius: 8px 8px 0 0;">
            <span style="font-weight: 600; font-size: 0.9rem; color: var(--text-secondary);">BOWLING</span>
        </div>
        
        <!-- Bowling Table -->
        <table class="espn-scorecard" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: var(--bg-tertiary); font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);">
                    <th style="text-align: left; padding: 0.5rem; width: 40%;">Bowler</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">O</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">M</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">R</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">W</th>
                    <th style="text-align: center; padding: 0.5rem; width: 10%;">Econ</th>
                </tr>
            </thead>
            <tbody id="innings2-bowling"></tbody>
        </table>
    </div>
</div>

<!-- Loading with Progress -->
<div id="loading" class="card" style="display: none;">
    <h3 style="text-align: center; margin-bottom: 1rem;">Running Simulation...</h3>
    
    <!-- Progress Bar -->
    <div style="background: var(--bg-tertiary); border-radius: 8px; height: 24px; overflow: hidden; margin-bottom: 1rem;">
        <div id="progress-fill" style="height: 100%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); width: 0%; transition: width 0.3s ease;"></div>
    </div>
    
    <!-- Progress Stats -->
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; text-align: center;">
        <div>
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-primary);" id="progress-count">0</div>
            <div style="color: var(--text-muted); font-size: 0.75rem;">COMPLETED</div>
        </div>
        <div>
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);" id="progress-rate">--</div>
            <div style="color: var(--text-muted); font-size: 0.75rem;">SIMS/SEC</div>
        </div>
        <div>
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-secondary);" id="progress-eta">--</div>
            <div style="color: var(--text-muted); font-size: 0.75rem;">ETA (SEC)</div>
        </div>
    </div>
    
    <p style="text-align: center; color: var(--text-muted); margin-top: 1rem; font-size: 0.875rem;" id="progress-status">
        Initializing...
    </p>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Current gender selection (for API match loading)
    let currentGender = 'male';
    let currentSeriesId = '';
    let currentSeriesName = '';
    
    // Data source: 'espn' or 'api'
    let currentDataSource = 'espn';
    
    // Timezone: default to Melbourne
    let currentTimezone = localStorage.getItem('cricket_timezone') || 'Australia/Melbourne';
    
    // Team filter state (for manual selection)
    const teamFilters = {
        1: { gender: 'male', type: 'all' },
        2: { gender: 'male', type: 'all' }
    };
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        // Set timezone dropdown to saved value
        const tzSelect = document.getElementById('timezone-select');
        if (tzSelect) {
            tzSelect.value = currentTimezone;
        }
        
        loadTeamsForTeam(1);
        loadTeamsForTeam(2);
        loadVenues();
        loadUpcomingMatches();  // Load upcoming matches
    });
    
    // Set timezone and refresh display
    function setTimezone(tz) {
        currentTimezone = tz;
        localStorage.setItem('cricket_timezone', tz);
        // Reload matches to update displayed times
        loadUpcomingMatches();
    }
    
    // Format a GMT ISO datetime string in the selected timezone
    function formatTimeInTimezone(gmtIsoString) {
        if (!gmtIsoString) return null;
        
        try {
            const dt = new Date(gmtIsoString.endsWith('Z') ? gmtIsoString : gmtIsoString + 'Z');
            if (isNaN(dt.getTime())) return null;
            
            return dt.toLocaleString('en-AU', {
                timeZone: currentTimezone,
                weekday: 'short',
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        } catch (e) {
            console.error('Error formatting time:', e);
            return null;
        }
    }
    
    // Get short timezone abbreviation
    function getTimezoneAbbr() {
        try {
            const dt = new Date();
            const parts = dt.toLocaleString('en-AU', {
                timeZone: currentTimezone,
                timeZoneName: 'short'
            }).split(' ');
            return parts[parts.length - 1];
        } catch (e) {
            return '';
        }
    }
    
    // Calculate countdown from GMT time
    function calculateCountdown(gmtIsoString) {
        if (!gmtIsoString) return null;
        
        try {
            const dt = new Date(gmtIsoString.endsWith('Z') ? gmtIsoString : gmtIsoString + 'Z');
            if (isNaN(dt.getTime())) return null;
            
            const now = Date.now();
            const diff = dt.getTime() - now;
            const absDiff = Math.abs(diff);
            const hours = Math.floor(absDiff / (1000 * 60 * 60));
            const mins = Math.floor((absDiff % (1000 * 60 * 60)) / (1000 * 60));
            
            let color = '#4caf50'; // Green
            let text = '';
            
            if (diff < 0) {
                // Match started (negative)
                color = '#f44336'; // Red
                text = '-' + hours + 'h ' + mins + 'm';
            } else if (diff < 60 * 60 * 1000) {
                // Within 1 hour
                color = '#ff9800'; // Orange
                text = hours + 'h ' + mins + 'm';
            } else {
                text = hours + 'h ' + mins + 'm';
            }
            
            return { text, color, timestamp: dt.getTime() };
        } catch (e) {
            return null;
        }
    }
    
    // Set data source and reload matches
    function setDataSource(source) {
        currentDataSource = source;
        
        // Update button states
        const control = document.getElementById('data-source-control');
        control.querySelectorAll('button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === source);
        });
        
        // Update info text
        const info = document.getElementById('source-info');
        if (source === 'espn') {
            info.textContent = 'ESPN Cricinfo provides comprehensive coverage of all T20 matches worldwide';
        } else {
            info.textContent = 'Cricket Data API - requires API key, covers major tournaments only';
        }
        
        // Reload matches
        loadUpcomingMatches();
    }
    
    // Set team filter and reload teams
    function setTeamFilter(teamNum, filterType, value) {
        teamFilters[teamNum][filterType] = value;
        
        // Update button states
        const controlId = `team${teamNum}-${filterType === 'gender' ? 'gender' : 'type'}-control`;
        const control = document.getElementById(controlId);
        control.querySelectorAll('button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === value);
        });
        
        // Reload teams for this team
        loadTeamsForTeam(teamNum);
    }
    
    // Load teams for a specific team panel
    async function loadTeamsForTeam(teamNum) {
        const { gender, type } = teamFilters[teamNum];
        
        try {
            const response = await fetch(`/api/teams?gender=${gender}&team_type=${type}`);
            const data = await response.json();
            
            if (data.success) {
                const select = document.getElementById(`team${teamNum}-select`);
                const countSpan = document.getElementById(`team${teamNum}-count`);
                const currentValue = select.value;
                
                select.innerHTML = '<option value="">-- Select Team --</option>';
                data.teams.forEach(team => {
                    const opt = document.createElement('option');
                    opt.value = team.team_id;
                    opt.textContent = team.name;
                    select.appendChild(opt);
                });
                
                // Try to restore selection, or clear if not in new list
                if (currentValue) {
                    select.value = currentValue;
                    if (select.value !== currentValue) {
                        // Team not in filtered list, clear players
                        clearPlayersForTeam(teamNum);
                    }
                }
                
                // Update count display
                countSpan.textContent = `(${data.count} teams)`;
            }
        } catch (error) {
            console.error(`Error loading teams for team ${teamNum}:`, error);
        }
    }
    
    // Clear player selections for a team
    function clearPlayersForTeam(teamNum) {
        document.getElementById(`team${teamNum}-batters`).innerHTML = '';
        document.getElementById(`team${teamNum}-bowlers`).innerHTML = '';
    }
    
    // Upcoming Matches Functions
    async function loadUpcomingMatches(forceRefresh = false) {
        const loadingEl = document.getElementById('matches-loading');
        const listEl = document.getElementById('matches-list');
        const emptyEl = document.getElementById('matches-empty');
        
        loadingEl.style.display = 'block';
        listEl.style.display = 'none';
        emptyEl.style.display = 'none';
        
        try {
            // Choose endpoint based on data source
            let endpoint = currentDataSource === 'espn' 
                ? '/api/espn/upcoming'
                : '/api/t20/upcoming';
            
            // Add refresh parameter if forcing
            if (forceRefresh && currentDataSource === 'espn') {
                endpoint += '?refresh=true';
            }
            
            const response = await fetch(endpoint);
            const data = await response.json();
            
            loadingEl.style.display = 'none';
            
            if (data.success && data.matches_by_series.length > 0) {
                listEl.innerHTML = '';
                
                data.matches_by_series.forEach(series => {
                    const genderBadge = series.gender === 'female' ? 
                        '<span style="background: #e91e63; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">W</span>' :
                        '<span style="background: #2196f3; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">M</span>';
                    
                    const seriesHtml = `
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1rem; color: var(--accent-primary); margin-bottom: 0.5rem; display: flex; align-items: center;">
                                ${series.series_name} ${genderBadge}
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                ${series.matches.map(m => {
                                    // Use timezone-aware formatting
                                    let displayDateTime = '';
                                    let countdownHtml = '';
                                    let matchTimestamp = 0;
                                    
                                    if (m.date_time_gmt) {
                                        // Format in selected timezone
                                        const formatted = formatTimeInTimezone(m.date_time_gmt);
                                        if (formatted) {
                                            displayDateTime = formatted;
                                        }
                                        
                                        // Calculate countdown
                                        const countdown = calculateCountdown(m.date_time_gmt);
                                        if (countdown) {
                                            matchTimestamp = countdown.timestamp;
                                            countdownHtml = '<span class="countdown-timer" data-timestamp="' + matchTimestamp + '" style="font-weight: 600; color: ' + countdown.color + '; font-size: 0.85rem; min-width: 70px; text-align: right;">' + countdown.text + '</span>';
                                        }
                                    }
                                    
                                    // Fallback if no parsed datetime
                                    if (!displayDateTime) {
                                        displayDateTime = m.start_time ? m.start_time : (m.status || 'TBD');
                                    }
                                    
                                    // Handle both ESPN and API data formats
                                    let matchTitle;
                                    if (m.team1 && m.team2) {
                                        matchTitle = m.team1 + ' vs ' + m.team2;
                                    } else {
                                        matchTitle = m.title || 'TBD vs TBD';
                                    }
                                    const matchType = m.match_type || '';
                                    // Use venue_city from schedule, fallback to venue
                                    const matchVenue = m.venue_city || m.venue || '';
                                    const matchId = m.match_id || m.espn_id || '';
                                    const matchUrl = m.match_url || '';
                                    const hasSquad = m.has_squad || m.has_squads || false;
                                    const isEspn = currentDataSource === 'espn';
                                    
                                    // Get prefetch status if available
                                    const prefetchStatus = prefetchData[matchUrl] || {};
                                    let statusIcons = '';
                                    if (prefetchStatus.venue_found) {
                                        statusIcons += '<span style="color: #4caf50;" title="Venue matched to DB">üìç‚úì</span>';
                                    } else if (prefetchStatus.venue_name) {
                                        statusIcons += '<span style="color: #ff9800;" title="Venue: ' + prefetchStatus.venue_name + ' (not in DB)">üìç?</span>';
                                    }
                                    if (prefetchStatus.team1_squad) {
                                        statusIcons += '<span style="color: #4caf50;" title="Team 1: ' + prefetchStatus.team1_count + ' players"> T1‚úì</span>';
                                    }
                                    if (prefetchStatus.team2_squad) {
                                        statusIcons += '<span style="color: #4caf50;" title="Team 2: ' + prefetchStatus.team2_count + ' players"> T2‚úì</span>';
                                    }
                                    
                                    return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${series.gender === 'female' ? '#e91e63' : '#2196f3'};" data-match-url="${matchUrl}">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500;">${matchTitle}${matchType ? ' <span style="font-weight: 400; color: var(--text-muted); font-size: 0.85rem;">(' + matchType + ')</span>' : ''}</div>
                                            <div style="font-size: 0.8rem; color: var(--text-muted);">
                                                <span style="color: var(--text-secondary);">${displayDateTime}</span>${matchVenue ? ' ‚Ä¢ ' + matchVenue : ''}
                                                <span class="prefetch-status" style="margin-left: 0.5rem;">${statusIcons}</span>
                                                ${isEspn ? '<span style="color: #ff9800; margin-left: 0.5rem;">ESPNcricinfo</span>' : ''}
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            ${countdownHtml}
                                            <button class="btn btn-primary" style="padding: 0.4rem 1rem; font-size: 0.85rem;" 
                                                    onclick="selectMatch('${isEspn ? matchUrl : matchId}', '${series.gender}', ${isEspn})">
                                                Select
                                            </button>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    `;
                    listEl.innerHTML += seriesHtml;
                });
                
                listEl.style.display = 'block';
                console.log(`Loaded ${data.total_matches} upcoming matches`);
                
                // Start the countdown timer updater
                startCountdownUpdater();
                
                // Update prefetch status display from cached data
                updatePrefetchStatusDisplay();
            } else {
                emptyEl.style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading upcoming matches:', error);
            loadingEl.style.display = 'none';
            emptyEl.innerHTML = '<p style="color: var(--danger);">Error loading matches. Please try again.</p>';
            emptyEl.style.display = 'block';
        }
    }
    
    // Store prefetch status data
    let prefetchData = {};
    
    // Pre-fetch all match data
    async function prefetchAllMatches() {
        const btn = document.getElementById('prefetch-btn');
        const status = document.getElementById('prefetch-status');
        
        btn.disabled = true;
        btn.textContent = '‚è≥ Fetching...';
        status.textContent = 'Loading match details...';
        
        try {
            const response = await fetch('/api/espn/prefetch?hours_ahead=24', { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                // Store the prefetch data
                prefetchData = {};
                data.matches.forEach(m => {
                    prefetchData[m.match_url] = m;
                });
                
                // Update display
                const withVenue = data.matches.filter(m => m.venue_found).length;
                const withSquads = data.matches.filter(m => m.team1_squad || m.team2_squad).length;
                
                status.innerHTML = `<span style="color: var(--success);">‚úì ${data.cached_count}/${data.total} cached</span> | Venues: ${withVenue} | Squads: ${withSquads}`;
                
                // Reload matches to show updated status indicators
                await loadUpcomingMatches(false);
                
                console.log('Prefetch complete:', data);
            } else {
                status.innerHTML = `<span style="color: var(--danger);">‚úó ${data.error}</span>`;
            }
        } catch (error) {
            console.error('Prefetch error:', error);
            status.innerHTML = `<span style="color: var(--danger);">‚úó Error</span>`;
        } finally {
            btn.disabled = false;
            btn.textContent = 'üì• Pre-fetch Data';
        }
    }
    
    // Update match cards with prefetch status indicators
    function updateMatchCardsWithPrefetchStatus() {
        // Find all match cards and update their status indicators
        const cards = document.querySelectorAll('#matches-list [data-match-url]');
        cards.forEach(card => {
            const url = card.dataset.matchUrl;
            const status = prefetchData[url];
            if (status) {
                const statusEl = card.querySelector('.prefetch-status');
                if (statusEl) {
                    let html = '';
                    if (status.venue_found) {
                        html += '<span style="color: #4caf50;" title="Venue matched">üìç‚úì</span>';
                    } else if (status.venue_name) {
                        html += '<span style="color: #ff9800;" title="Venue not in DB">üìç?</span>';
                    }
                    if (status.team1_squad) {
                        html += `<span style="color: #4caf50;" title="${status.team1_count} players">üë•‚úì</span>`;
                    }
                    if (status.team2_squad) {
                        html += `<span style="color: #4caf50;" title="${status.team2_count} players">üë•‚úì</span>`;
                    }
                    statusEl.innerHTML = html;
                }
            }
        });
    }
    
    // Update status display after loading matches (for cached data)
    function updatePrefetchStatusDisplay() {
        if (Object.keys(prefetchData).length > 0) {
            updateMatchCardsWithPrefetchStatus();
        }
    }
    
    // Countdown timer updater
    let countdownInterval = null;
    
    function startCountdownUpdater() {
        // Clear any existing interval
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        
        // Update immediately
        updateCountdowns();
        
        // Then update every 30 seconds
        countdownInterval = setInterval(updateCountdowns, 30000);
    }
    
    function updateCountdowns() {
        const timers = document.querySelectorAll('.countdown-timer');
        const now = Date.now();
        
        timers.forEach(timer => {
            const timestamp = parseInt(timer.dataset.timestamp);
            if (!timestamp) return;
            
            const diff = timestamp - now;
            const absDiff = Math.abs(diff);
            const hours = Math.floor(absDiff / (1000 * 60 * 60));
            const mins = Math.floor((absDiff % (1000 * 60 * 60)) / (1000 * 60));
            
            let color = '#4caf50'; // Green
            let text = '';
            
            if (diff < 0) {
                // Match has started (negative countdown)
                color = '#f44336'; // Red
                text = '-' + hours + 'h ' + mins + 'm';
            } else if (diff < 60 * 60 * 1000) {
                // Within 1 hour
                color = '#ff9800'; // Orange
                text = hours + 'h ' + mins + 'm';
            } else {
                // More than 1 hour away
                text = hours + 'h ' + mins + 'm';
            }
            
            timer.style.color = color;
            timer.textContent = text;
        });
    }
    
    async function selectMatch(matchIdOrUrl, gender, isEspn = false) {
        // Set the gender for correct model selection
        currentGender = gender;
        
        // Sync segmented controls to match gender AND set type to "all" for API matches
        // (API matches can be international or franchise, so we need all teams)
        [1, 2].forEach(teamNum => {
            teamFilters[teamNum].gender = gender;
            teamFilters[teamNum].type = 'all';  // Show all teams for API matches
            
            // Update gender control
            const genderControl = document.getElementById(`team${teamNum}-gender-control`);
            genderControl.querySelectorAll('button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === gender);
            });
            
            // Update type control - select "all"
            const typeControl = document.getElementById(`team${teamNum}-type-control`);
            typeControl.querySelectorAll('button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === 'all');
            });
        });
        
        console.log(`[DEBUG] selectMatch - Loading teams for gender: ${gender}, type: all`);
        
        // Load teams (all types) and venues for this gender
        await loadTeams();
        console.log(`[DEBUG] selectMatch - Teams loaded successfully`);
        
        // Small delay to ensure dropdown DOM is fully updated
        await new Promise(resolve => setTimeout(resolve, 150));
        console.log(`[DEBUG] selectMatch - Dropdown population delay complete`);
        
        await loadVenues();
        console.log(`[DEBUG] selectMatch - Venues loaded successfully`);
        
        // Load the match - use ESPN or API endpoint based on source
        if (isEspn) {
            await loadEspnMatch(matchIdOrUrl);
        } else {
            await loadT20MatchById(matchIdOrUrl);
        }
    }
    
    async function loadEspnMatch(matchUrl) {
        if (!matchUrl) {
            alert('Invalid match URL');
            return;
        }
        
        // Show loading
        document.getElementById('t20-loading').style.display = 'block';
        document.getElementById('t20-match-info').style.display = 'none';
        
        try {
            const response = await fetch(`/api/espn/match?url=${encodeURIComponent(matchUrl)}`);
            const data = await response.json();
            
            document.getElementById('t20-loading').style.display = 'none';
            
            if (data.success && data.match) {
                const match = data.match;
                
                // Show match info
                const team1Name = match.team1?.long_name || match.team1_db?.name || 'Team 1';
                const team2Name = match.team2?.long_name || match.team2_db?.name || 'Team 2';
                document.getElementById('t20-match-name').textContent = `${team1Name} vs ${team2Name}`;
                document.getElementById('t20-match-date').textContent = `${match.start_date} ${match.start_time || ''}`;
                
                const team1Players = match.team1?.players?.length || 0;
                const team2Players = match.team2?.players?.length || 0;
                const team1Matched = match.team1?.players?.filter(p => p.db_player_id)?.length || 0;
                const team2Matched = match.team2?.players?.filter(p => p.db_player_id)?.length || 0;
                
                document.getElementById('t20-team1-info').textContent = `${team1Matched}/${team1Players} matched`;
                document.getElementById('t20-team2-info').textContent = `${team2Matched}/${team2Players} matched`;
                document.getElementById('t20-match-info').style.display = 'block';
                
                console.log(`ESPN match loaded: ${team1Name} vs ${team2Name}`);
                console.log(`  Venue: ${match.venue?.name} -> DB: ${match.venue?.db_venue_name}`);
                
                // Auto-fill teams from ESPN data
                if (match.team1_db) {
                    await autoFillTeamFromEspn(1, match.team1_db.name, match.team1);
                }
                if (match.team2_db) {
                    await autoFillTeamFromEspn(2, match.team2_db.name, match.team2);
                }
                
                // Auto-select venue if matched
                if (match.venue?.db_venue_id) {
                    const venueSelect = document.getElementById('venue-select');
                    venueSelect.value = match.venue.db_venue_id;
                    console.log(`Auto-selected venue: ${match.venue.db_venue_name} (ID: ${match.venue.db_venue_id})`);
                }
                
                // Enable toss simulation
                document.getElementById('use-toss').checked = true;
                
            } else {
                alert('Error loading ESPN match: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            document.getElementById('t20-loading').style.display = 'none';
            console.error('Error loading ESPN match:', error);
            alert('Error loading match data from ESPN');
        }
    }
    
    async function autoFillTeamFromEspn(teamNum, dbTeamName, espnTeam) {
        // Find and select the team by name
        const teamSelect = document.getElementById(`team${teamNum}-select`);
        let teamFound = false;
        let teamId = null;
        
        console.log(`[DEBUG] Team ${teamNum} - Looking for: "${dbTeamName}"`);
        console.log(`[DEBUG] Team ${teamNum} - Dropdown has ${teamSelect.options.length} options`);
        
        // Log first 10 options for debugging
        const availableOptions = Array.from(teamSelect.options).slice(0, 10).map(opt => `"${opt.textContent}"`);
        console.log(`[DEBUG] Team ${teamNum} - First 10 options:`, availableOptions.join(', '));
        
        for (let opt of teamSelect.options) {
            if (opt.textContent === dbTeamName) {
                teamSelect.value = opt.value;
                teamId = opt.value;
                teamFound = true;
                console.log(`[DEBUG] Team ${teamNum} - FOUND match: "${opt.textContent}" (ID: ${opt.value})`);
                break;
            }
        }
        
        if (!teamFound) {
            console.warn(`[DEBUG] Team ${teamNum} - NOT FOUND in dropdown: "${dbTeamName}"`);
            console.warn(`[DEBUG] Team ${teamNum} - All available teams:`, Array.from(teamSelect.options).map(opt => `"${opt.textContent}"`));
            return;
        }
        
        console.log(`[DEBUG] Team ${teamNum} - espnTeam:`, espnTeam);
        console.log(`[DEBUG] Team ${teamNum} - espnTeam.players:`, espnTeam?.players);
        
        // Get matched players from ESPN data
        const matchedPlayers = espnTeam?.players?.filter(p => p.db_player_id) || [];
        
        console.log(`[DEBUG] Team ${teamNum} - matchedPlayers length: ${matchedPlayers.length}`);
        
        // If ESPN has no matched players, fall back to recent lineup from our database
        if (matchedPlayers.length === 0) {
            console.log(`[DEBUG] Team ${teamNum} (${dbTeamName}): No ESPN squad matched to DB, loading recent lineup from database...`);
            await loadPlayers(teamNum);  // Load historical players
            await new Promise(resolve => setTimeout(resolve, 100));
            await loadRecentLineupForTeam(teamNum, teamId);
            return;
        }
        
        // Populate batters and bowlers dropdowns with ESPN-matched players
        const battersSelect = document.getElementById(`team${teamNum}-batters`);
        const bowlersSelect = document.getElementById(`team${teamNum}-bowlers`);
        
        battersSelect.innerHTML = '';
        bowlersSelect.innerHTML = '';
        
        console.log(`[DEBUG] Team ${teamNum} - Populating dropdowns with ${matchedPlayers.length} matched players`);
        
        // Add all matched players to both batters and bowlers
        // (since ESPN doesn't provide roles and DB might not have reliable role data)
        for (let player of matchedPlayers) {
            // Add to batters
            const batterOpt = document.createElement('option');
            batterOpt.value = player.db_player_id;
            batterOpt.textContent = player.name;
            batterOpt.selected = true;
            battersSelect.appendChild(batterOpt);
            
            // Add to bowlers
            const bowlerOpt = document.createElement('option');
            bowlerOpt.value = player.db_player_id;
            bowlerOpt.textContent = player.name;
            bowlerOpt.selected = true;
            bowlersSelect.appendChild(bowlerOpt);
        }
        
        console.log(`[DEBUG] Team ${teamNum} - Populated ${battersSelect.options.length} batters, ${bowlersSelect.options.length} bowlers from ESPN`);
        console.log(`Team ${teamNum} (${dbTeamName}): Auto-selected ${matchedPlayers.length} players (all in both batters and bowlers)`);
    }
    
    async function loadRecentLineupForTeam(teamNum, teamId) {
        // Fetch recent lineup from our database
        try {
            const response = await fetch(`/api/team/${teamId}/recent-lineup?gender=${currentGender}`);
            const data = await response.json();
            
            if (data.success && data.recent_xi && data.recent_xi.length > 0) {
                const battersSelect = document.getElementById(`team${teamNum}-batters`);
                const bowlersSelect = document.getElementById(`team${teamNum}-bowlers`);
                
                // Clear current selections
                for (let opt of battersSelect.options) opt.selected = false;
                for (let opt of bowlersSelect.options) opt.selected = false;
                
                let battersSelected = 0;
                let bowlersSelected = 0;
                
                // Select players from recent XI
                for (let player of data.recent_xi) {
                    const playerId = player.player_id;
                    
                    // Try batters first
                    for (let opt of battersSelect.options) {
                        if (parseInt(opt.value) === playerId && !opt.selected) {
                            opt.selected = true;
                            battersSelected++;
                            break;
                        }
                    }
                    // Also try bowlers
                    for (let opt of bowlersSelect.options) {
                        if (parseInt(opt.value) === playerId && !opt.selected) {
                            opt.selected = true;
                            bowlersSelected++;
                            break;
                        }
                    }
                }
                
                console.log(`Team ${teamNum}: Loaded ${battersSelected} batters, ${bowlersSelected} bowlers from recent DB lineup`);
            } else {
                console.warn(`Team ${teamNum}: No recent lineup found in database`);
            }
        } catch (error) {
            console.error(`Error loading recent lineup for team ${teamNum}:`, error);
        }
    }
    
    async function loadT20MatchById(matchId) {
        if (!matchId) {
            alert('Invalid match ID');
            return;
        }
        
        // Show loading
        document.getElementById('t20-loading').style.display = 'block';
        document.getElementById('t20-match-info').style.display = 'none';
        
        try {
            const response = await fetch(`/api/t20/match/${matchId}`);
            const data = await response.json();
            
            document.getElementById('t20-loading').style.display = 'none';
            
            if (data.from_database && data.match) {
                // DATABASE FALLBACK: No API squad, using recent lineups from our database
                const match = data.match;
                
                // Show match info with database info
                document.getElementById('t20-match-name').textContent = `${match.team1_db_name} vs ${match.team2_db_name}`;
                document.getElementById('t20-match-date').textContent = match.date;
                document.getElementById('t20-team1-info').textContent = `${match.team1_players.length} from last match (${match.team1_last_match || 'N/A'})`;
                document.getElementById('t20-team2-info').textContent = `${match.team2_players.length} from last match (${match.team2_last_match || 'N/A'})`;
                document.getElementById('t20-match-info').style.display = 'block';
                
                // Show info message
                console.log(`Using database lineups: ${match.team1_db_name} (${match.team1_recent_xi.length} players), ${match.team2_db_name} (${match.team2_recent_xi.length} players)`);
                
                // Auto-fill teams using database recent XI
                await autoFillTeamFromDB(1, match.team1_db_name, match.team1_recent_xi);
                await autoFillTeamFromDB(2, match.team2_db_name, match.team2_recent_xi);
                
                // Auto-select venue if found
                if (match.venue_db_id) {
                    const venueSelect = document.getElementById('venue-select');
                    venueSelect.value = match.venue_db_id;
                    console.log(`Auto-selected venue: ${match.venue_db_name} (ID: ${match.venue_db_id})`);
                }
                
                // Enable toss simulation
                document.getElementById('use-toss').checked = true;
                
            } else if (data.success && data.match) {
                // API SQUAD: Full squad data from Cricket Data API
                const match = data.match;
                
                // Show match info
                document.getElementById('t20-match-name').textContent = `${match.team1_db_name} vs ${match.team2_db_name}`;
                document.getElementById('t20-match-date').textContent = match.date;
                
                const matched1 = match.team1_squad.filter(p => p.matched).length;
                const matched2 = match.team2_squad.filter(p => p.matched).length;
                document.getElementById('t20-team1-info').textContent = `${matched1}/${match.team1_squad.length} players`;
                document.getElementById('t20-team2-info').textContent = `${matched2}/${match.team2_squad.length} players`;
                document.getElementById('t20-match-info').style.display = 'block';
                
                // Auto-fill teams
                await autoFillTeam(1, match.team1_db_name, match.team1_squad, match.team1_suggested_xi);
                await autoFillTeam(2, match.team2_db_name, match.team2_squad, match.team2_suggested_xi);
                
                // Auto-select venue if we found a match
                if (match.venue_db_id) {
                    const venueSelect = document.getElementById('venue-select');
                    venueSelect.value = match.venue_db_id;
                    console.log(`Auto-selected venue: ${match.venue_db_name} (ID: ${match.venue_db_id})`);
                }
                
                // Enable toss simulation for upcoming matches
                document.getElementById('use-toss').checked = true;
                
            } else {
                alert('Error loading match: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            document.getElementById('t20-loading').style.display = 'none';
            console.error('Error loading T20 match:', error);
            alert('Error loading match data');
        }
    }
    
    // Legacy WBBL functions (kept for backward compatibility)
    async function loadWBBLFixtures() {
        // Redirect to the new series-based loader
        console.log('Legacy loadWBBLFixtures called - use loadT20Series instead');
    }
    
    async function loadWBBLMatch() {
        // Redirect to the new T20 loader
        console.log('Legacy loadWBBLMatch called - use loadT20Match instead');
    }
    
    async function autoFillTeamFromDB(teamNum, teamName, recentXI) {
        // Find and select the team by name
        const teamSelect = document.getElementById(`team${teamNum}-select`);
        let teamFound = false;
        
        for (let opt of teamSelect.options) {
            if (opt.textContent === teamName) {
                teamSelect.value = opt.value;
                teamFound = true;
                break;
            }
        }
        
        if (!teamFound) {
            console.warn(`Team not found in dropdown: ${teamName}`);
            return;
        }
        
        // Load players for this team
        await loadPlayers(teamNum);
        
        // Small delay to ensure DOM is updated
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Select the recent XI players
        const battersSelect = document.getElementById(`team${teamNum}-batters`);
        const bowlersSelect = document.getElementById(`team${teamNum}-bowlers`);
        
        // Clear current selections
        for (let opt of battersSelect.options) opt.selected = false;
        for (let opt of bowlersSelect.options) opt.selected = false;
        
        let battersSelected = 0;
        let bowlersSelected = 0;
        
        // Select players from recent XI (first in batters, then in bowlers)
        for (let playerId of recentXI) {
            // Try batters first
            for (let opt of battersSelect.options) {
                if (parseInt(opt.value) === playerId && !opt.selected) {
                    opt.selected = true;
                    battersSelected++;
                    break;
                }
            }
            // If not in batters (or not selected), try bowlers
            let foundInBatters = Array.from(battersSelect.options).some(opt => parseInt(opt.value) === playerId && opt.selected);
            if (!foundInBatters) {
                for (let opt of bowlersSelect.options) {
                    if (parseInt(opt.value) === playerId && !opt.selected) {
                        opt.selected = true;
                        bowlersSelected++;
                        break;
                    }
                }
            }
        }
        
        console.log(`Team ${teamNum} (${teamName}): Selected ${battersSelected} batters, ${bowlersSelected} bowlers from recent XI`);
    }
    
    async function autoFillTeam(teamNum, teamName, squad, suggestedXI) {
        // Find and select the team
        const teamSelect = document.getElementById(`team${teamNum}-select`);
        for (let opt of teamSelect.options) {
            if (opt.textContent === teamName) {
                teamSelect.value = opt.value;
                break;
            }
        }
        
        // Load players for this team
        await loadPlayers(teamNum);
        
        // Small delay to ensure DOM is updated
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Select the suggested XI in batters list
        const battersSelect = document.getElementById(`team${teamNum}-batters`);
        const bowlersSelect = document.getElementById(`team${teamNum}-bowlers`);
        
        // Clear current selections
        for (let opt of battersSelect.options) opt.selected = false;
        for (let opt of bowlersSelect.options) opt.selected = false;
        
        // Select suggested players
        let battersSelected = 0;
        let bowlersSelected = 0;
        
        for (let playerId of suggestedXI) {
            // Try to select in batters list
            for (let opt of battersSelect.options) {
                if (parseInt(opt.value) === playerId && battersSelected < 11) {
                    opt.selected = true;
                    battersSelected++;
                    break;
                }
            }
            
            // Also try bowlers list
            for (let opt of bowlersSelect.options) {
                if (parseInt(opt.value) === playerId && bowlersSelected < 5) {
                    opt.selected = true;
                    bowlersSelected++;
                }
            }
        }
        
        console.log(`Team ${teamNum}: Selected ${battersSelected} batters, ${bowlersSelected} bowlers`);
    }
    
    async function loadTeams() {
        // Legacy function - now loads teams for both panels
        await loadTeamsForTeam(1);
        await loadTeamsForTeam(2);
    }
    
    async function loadVenues() {
        try {
            const response = await fetch(`/api/venues?gender=${currentGender}&min_matches=3`);
            const data = await response.json();
            
            console.log('Venues API response:', data.success, 'hierarchical:', !!data.venues_hierarchical, 'countries:', data.venues_hierarchical?.length);
            
            if (data.success && data.venues_hierarchical) {
                const venueSelect = document.getElementById('venue-select');
                if (!venueSelect) {
                    console.error('venue-select element not found!');
                    return;
                }
                venueSelect.innerHTML = '<option value="">-- Neutral Venue --</option>';
                
                let totalVenues = 0;
                // Use hierarchical data for grouped dropdown
                data.venues_hierarchical.forEach(country => {
                    // Create optgroup for each country
                    const countryGroup = document.createElement('optgroup');
                    countryGroup.label = `${country.flag} ${country.name}`;
                    
                    country.cities.forEach(city => {
                        city.venues.forEach(venue => {
                            const opt = document.createElement('option');
                            opt.value = venue.venue_id;
                            // Format: "City ‚Ä¢ Venue Name (X matches)"
                            opt.textContent = `${city.name} ‚Ä¢ ${venue.name} (${venue.match_count})`;
                            countryGroup.appendChild(opt);
                            totalVenues++;
                        });
                    });
                    
                    if (countryGroup.children.length > 0) {
                        venueSelect.appendChild(countryGroup);
                    }
                });
                console.log('Loaded', totalVenues, 'venues into dropdown');
            } else if (data.success && data.venues) {
                // Fallback to flat list
                const venueSelect = document.getElementById('venue-select');
                venueSelect.innerHTML = '<option value="">-- Neutral Venue --</option>';
                data.venues.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.venue_id;
                    opt.textContent = `${v.name}${v.city ? ', ' + v.city : ''} (${v.match_count} matches)`;
                    venueSelect.appendChild(opt);
                });
            }
        } catch (error) {
            console.error('Error loading venues:', error);
        }
    }
    
    async function loadPlayers(teamNum) {
        const teamId = document.getElementById(`team${teamNum}-select`).value;
        if (!teamId) return;
        
        // Use the team-specific gender filter, not the global currentGender
        const gender = teamFilters[teamNum].gender;
        const response = await fetch(`/api/players/${teamId}?gender=${gender}`);
        const data = await response.json();
        
        if (data.success) {
            // Populate batters
            const battersSelect = document.getElementById(`team${teamNum}-batters`);
            battersSelect.innerHTML = '';
            data.batters.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.player_id;
                opt.textContent = `${p.name} (${p.total_runs} runs)`;
                battersSelect.appendChild(opt);
            });
            
            // Populate bowlers
            const bowlersSelect = document.getElementById(`team${teamNum}-bowlers`);
            bowlersSelect.innerHTML = '';
            data.bowlers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.player_id;
                opt.textContent = `${p.name} (${p.total_wickets} wkts)`;
                bowlersSelect.appendChild(opt);
            });
            
            // Auto-select top players
            selectTop(battersSelect, 11);
            selectTop(bowlersSelect, 5);
        }
    }
    
    function selectTop(selectEl, n) {
        const options = selectEl.options;
        for (let i = 0; i < Math.min(n, options.length); i++) {
            options[i].selected = true;
        }
    }
    
    function getSelectedValues(selectId) {
        const select = document.getElementById(selectId);
        return Array.from(select.selectedOptions).map(opt => parseInt(opt.value));
    }
    
    async function runSimulation() {
        const team1Name = document.getElementById('team1-select').selectedOptions[0]?.text || 'Team 1';
        const team2Name = document.getElementById('team2-select').selectedOptions[0]?.text || 'Team 2';
        
        const team1Batters = getSelectedValues('team1-batters');
        const team1Bowlers = getSelectedValues('team1-bowlers');
        const team2Batters = getSelectedValues('team2-batters');
        const team2Bowlers = getSelectedValues('team2-bowlers');
        
        if (team1Batters.length === 0 || team2Batters.length === 0) {
            alert('Please select players for both teams');
            return;
        }
        
        // Deduplicate batters (each player can only bat once!)
        const uniqueTeam1Batters = [...new Set(team1Batters)];
        const uniqueTeam2Batters = [...new Set(team2Batters)];
        
        if (uniqueTeam1Batters.length < team1Batters.length) {
            console.warn(`Removed ${team1Batters.length - uniqueTeam1Batters.length} duplicate Team 1 batters`);
        }
        if (uniqueTeam2Batters.length < team2Batters.length) {
            console.warn(`Removed ${team2Batters.length - uniqueTeam2Batters.length} duplicate Team 2 batters`);
        }
        
        // Get venue and toss options
        const venueSelect = document.getElementById('venue-select');
        const venueId = venueSelect.value ? parseInt(venueSelect.value) : null;
        const useToss = document.getElementById('use-toss').checked;
        const nSimulations = parseInt(document.getElementById('n-simulations').value);
        
        // Show loading with progress
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results').style.display = 'none';
        document.getElementById('scorecard-section').style.display = 'none';
        
        // Reset progress UI
        document.getElementById('progress-fill').style.width = '0%';
        document.getElementById('progress-count').textContent = '0';
        document.getElementById('progress-rate').textContent = '--';
        document.getElementById('progress-eta').textContent = '--';
        document.getElementById('progress-status').textContent = `Starting ${nSimulations.toLocaleString()} simulations...`;
        
        // Smooth animation state
        let displayedCount = 0;
        let targetCount = 0;
        let currentRate = 100; // Default estimate: 100 sims/sec
        let animationInterval = null;
        let simulationComplete = false;
        
        // Start smooth animation loop (updates every 50ms)
        animationInterval = setInterval(() => {
            if (simulationComplete) {
                clearInterval(animationInterval);
                return;
            }
            
            // Smoothly increment towards target
            if (displayedCount < targetCount) {
                // Increment based on estimated rate
                const increment = currentRate / 20; // 50ms = 1/20 second
                displayedCount = Math.min(displayedCount + increment, targetCount);
                
                const pct = (displayedCount / nSimulations) * 100;
                const eta = currentRate > 0 ? (nSimulations - displayedCount) / currentRate : 0;
                
                document.getElementById('progress-fill').style.width = pct.toFixed(1) + '%';
                document.getElementById('progress-count').textContent = Math.round(displayedCount).toLocaleString();
                document.getElementById('progress-rate').textContent = Math.round(currentRate).toLocaleString();
                document.getElementById('progress-eta').textContent = eta.toFixed(1);
                document.getElementById('progress-status').textContent = 
                    `${Math.round(displayedCount).toLocaleString()} / ${nSimulations.toLocaleString()} simulations (${pct.toFixed(1)}%)`;
            }
        }, 50);
        
        const payload = {
            team1_batters: uniqueTeam1Batters,
            team1_bowlers: team1Bowlers,
            team2_batters: uniqueTeam2Batters,
            team2_bowlers: team2Bowlers,
            simulator: document.getElementById('simulator-type').value,
            n_simulations: nSimulations,
            venue_id: venueId,
            use_toss: useToss,
            gender: currentGender
        };
        
        try {
            // Use streaming endpoint for progress updates
            const response = await fetch('/api/simulate-stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                
                // Process complete SSE messages
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line in buffer
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.type === 'progress') {
                                // Update targets for smooth animation
                                targetCount = data.completed;
                                currentRate = data.rate;
                                // Animation loop will smoothly update the UI
                            }
                            else if (data.type === 'result') {
                                // Stop animation and show final results
                                simulationComplete = true;
                                clearInterval(animationInterval);
                                
                                // Ensure progress shows 100%
                                document.getElementById('progress-fill').style.width = '100%';
                                document.getElementById('progress-count').textContent = nSimulations.toLocaleString();
                                
                                // Small delay to show 100% before hiding
                                setTimeout(() => {
                                    document.getElementById('loading').style.display = 'none';
                                    displayResults(data, team1Name, team2Name);
                                }, 300);
                            }
                            else if (data.type === 'error') {
                                simulationComplete = true;
                                clearInterval(animationInterval);
                                document.getElementById('loading').style.display = 'none';
                                alert('Error: ' + data.error);
                            }
                        } catch (e) {
                            console.error('Error parsing SSE data:', e);
                        }
                    }
                }
            }
        } catch (error) {
            document.getElementById('loading').style.display = 'none';
            alert('Error running simulation: ' + error.message);
        }
    }
    
    function displayResults(data, team1Name, team2Name) {
        // Update results
        document.getElementById('result-team1-name').textContent = team1Name;
        document.getElementById('result-team2-name').textContent = team2Name;
        
        document.getElementById('result-team1-prob').textContent = data.team1_win_prob + '%';
        document.getElementById('result-team2-prob').textContent = data.team2_win_prob + '%';
        
        document.getElementById('result-team1-bar').style.width = data.team1_win_prob + '%';
        document.getElementById('result-team2-bar').style.width = data.team2_win_prob + '%';
        
        document.getElementById('result-team1-score').textContent = data.avg_team1_score;
        document.getElementById('result-team2-score').textContent = data.avg_team2_score;
        
        document.getElementById('result-team1-range').textContent = 
            `${data.team1_score_range[0]} - ${data.team1_score_range[1]}`;
        document.getElementById('result-team2-range').textContent = 
            `${data.team2_score_range[0]} - ${data.team2_score_range[1]}`;
        
        // Show toss info if available (now shows per-simulation statistics)
        const tossResult = document.getElementById('toss-result');
        if (data.toss_info) {
            const ti = data.toss_info;
            document.getElementById('toss-stats-text').textContent = 
                `Toss: Team 1 won ${ti.team1_won_toss_pct}% | Elected to field ${ti.chose_field_pct}% | Team 1 batted first ${ti.team1_batted_first_pct}%`;
            tossResult.style.display = 'block';
        } else {
            tossResult.style.display = 'none';
        }
        
        // Build meta string
        let meta = `${data.n_simulations.toLocaleString()} simulations using ${data.simulator === 'nn' ? 'Neural Network' : 'Fast Lookup'} engine in ${data.elapsed_ms.toFixed(0)}ms`;
        if (data.h2h_rate !== null && data.h2h_rate !== undefined) {
            meta += ` | H2H data used: ${data.h2h_rate}%`;
        }
        if (data.venue_id) {
            meta += ` | Venue #${data.venue_id}`;
        }
        document.getElementById('result-meta').textContent = meta;
        
        document.getElementById('results').style.display = 'block';
        
        // Display scorecard if available (NN simulator only)
        const scorecardSection = document.getElementById('scorecard-section');
        if (data.scorecard) {
            displayScorecard(data.scorecard, team1Name, team2Name);
            scorecardSection.style.display = 'block';
        } else {
            scorecardSection.style.display = 'none';
        }
    }
    
    function showInnings(inningsNum) {
        // Update tabs
        document.getElementById('tab-inn1').className = inningsNum === 1 ? 'btn btn-primary' : 'btn';
        document.getElementById('tab-inn2').className = inningsNum === 2 ? 'btn btn-primary' : 'btn';
        
        // Show/hide innings cards
        document.getElementById('innings1-card').style.display = inningsNum === 1 ? 'block' : 'none';
        document.getElementById('innings2-card').style.display = inningsNum === 2 ? 'block' : 'none';
    }
    
    function displayScorecard(scorecard, team1Name, team2Name) {
        // Helper to format overs
        const formatOvers = (overs) => {
            const fullOvers = Math.floor(overs);
            const balls = Math.round((overs % 1) * 10);
            return balls > 0 ? `${fullOvers}.${balls}` : `${fullOvers}`;
        };
        
        // Helper to format dismissal ESPN-style
        const formatDismissal = (b, bowlers) => {
            if (b.dismissal === 'not out') {
                return '<span style="color: var(--accent-green); font-weight: 500;">not out</span>';
            }
            // Find bowler name
            const bowlerName = bowlers.find(bl => bl.player_id === b.dismissed_by)?.name || 'Unknown';
            const shortBowlerName = bowlerName.split(' ').pop(); // Last name only
            return `<span style="color: var(--text-muted);">b ${shortBowlerName}</span>`;
        };
        
        // Result banner
        document.getElementById('scorecard-result-text').textContent = scorecard.result
            .replace('Team 1', team1Name)
            .replace('Team 2', team2Name);
        
        // ========== FIRST INNINGS ==========
        document.getElementById('innings1-team-name').textContent = team1Name + ' Innings';
        const overs1 = formatOvers(scorecard.team1_overs);
        document.getElementById('innings1-total').textContent = 
            `${scorecard.team1_total}/${scorecard.team1_wickets} (${overs1} Ov)`;
        
        // Calculate extras (estimate - total minus sum of individual runs)
        const battingRuns1 = scorecard.team1_batting.reduce((sum, b) => sum + b.runs, 0);
        const extras1 = Math.max(0, scorecard.team1_total - battingRuns1);
        document.getElementById('innings1-extras').textContent = `(b 0, lb 0, w ${extras1}, nb 0) ${extras1}`;
        document.getElementById('innings1-total-row').textContent = 
            `${scorecard.team1_total} (${scorecard.team1_wickets} wkts, ${overs1} Ov)`;
        
        // First innings batting
        const batting1 = document.getElementById('innings1-batting');
        batting1.innerHTML = '';
        scorecard.team1_batting.filter(b => b.balls > 0 || b.dismissal !== 'not out').forEach(b => {
            batting1.innerHTML += `
                <tr style="border-bottom: 1px solid var(--bg-tertiary);">
                    <td style="text-align: left; padding: 0.5rem;">
                        <div style="font-weight: 500;">${b.name || 'Player ' + b.player_id}</div>
                        <div style="font-size: 0.75rem;">${formatDismissal(b, scorecard.team2_bowling)}</div>
                    </td>
                    <td style="text-align: center; padding: 0.5rem; font-weight: 700;">${b.runs}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.balls}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.fours}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.sixes}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.strike_rate}</td>
                </tr>
            `;
        });
        
        // First innings bowling (Team 2's bowlers)
        const bowling1 = document.getElementById('innings1-bowling');
        bowling1.innerHTML = '';
        scorecard.team2_bowling.filter(b => b.balls > 0).forEach(b => {
            bowling1.innerHTML += `
                <tr style="border-bottom: 1px solid var(--bg-tertiary);">
                    <td style="text-align: left; padding: 0.5rem; font-weight: 500;">${b.name || 'Player ' + b.player_id}</td>
                    <td style="text-align: center; padding: 0.5rem;">${b.overs}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">0</td>
                    <td style="text-align: center; padding: 0.5rem;">${b.runs}</td>
                    <td style="text-align: center; padding: 0.5rem; font-weight: 700; color: ${b.wickets > 0 ? 'var(--accent-green)' : 'inherit'};">${b.wickets}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.economy}</td>
                </tr>
            `;
        });
        
        // ========== SECOND INNINGS ==========
        document.getElementById('innings2-team-name').textContent = team2Name + ' Innings';
        const overs2 = formatOvers(scorecard.team2_overs);
        document.getElementById('innings2-total').textContent = 
            `${scorecard.team2_total}/${scorecard.team2_wickets} (${overs2} Ov)`;
        document.getElementById('innings2-target').textContent = scorecard.target;
        
        // Calculate extras
        const battingRuns2 = scorecard.team2_batting.reduce((sum, b) => sum + b.runs, 0);
        const extras2 = Math.max(0, scorecard.team2_total - battingRuns2);
        document.getElementById('innings2-extras').textContent = `(b 0, lb 0, w ${extras2}, nb 0) ${extras2}`;
        document.getElementById('innings2-total-row').textContent = 
            `${scorecard.team2_total} (${scorecard.team2_wickets} wkts, ${overs2} Ov)`;
        
        // Second innings batting
        const batting2 = document.getElementById('innings2-batting');
        batting2.innerHTML = '';
        scorecard.team2_batting.filter(b => b.balls > 0 || b.dismissal !== 'not out').forEach(b => {
            batting2.innerHTML += `
                <tr style="border-bottom: 1px solid var(--bg-tertiary);">
                    <td style="text-align: left; padding: 0.5rem;">
                        <div style="font-weight: 500;">${b.name || 'Player ' + b.player_id}</div>
                        <div style="font-size: 0.75rem;">${formatDismissal(b, scorecard.team1_bowling)}</div>
                    </td>
                    <td style="text-align: center; padding: 0.5rem; font-weight: 700;">${b.runs}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.balls}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.fours}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.sixes}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.strike_rate}</td>
                </tr>
            `;
        });
        
        // Second innings bowling (Team 1's bowlers)
        const bowling2 = document.getElementById('innings2-bowling');
        bowling2.innerHTML = '';
        scorecard.team1_bowling.filter(b => b.balls > 0).forEach(b => {
            bowling2.innerHTML += `
                <tr style="border-bottom: 1px solid var(--bg-tertiary);">
                    <td style="text-align: left; padding: 0.5rem; font-weight: 500;">${b.name || 'Player ' + b.player_id}</td>
                    <td style="text-align: center; padding: 0.5rem;">${b.overs}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">0</td>
                    <td style="text-align: center; padding: 0.5rem;">${b.runs}</td>
                    <td style="text-align: center; padding: 0.5rem; font-weight: 700; color: ${b.wickets > 0 ? 'var(--accent-green)' : 'inherit'};">${b.wickets}</td>
                    <td style="text-align: center; padding: 0.5rem; color: var(--text-muted);">${b.economy}</td>
                </tr>
            `;
        });
        
        // Show first innings by default
        showInnings(1);
    }
</script>
{% endblock %}

