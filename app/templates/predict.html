{% extends "base.html" %}

{% block title %}Match Prediction - Cricket Predictor{% endblock %}

{% block content %}
<div class="hero" style="padding: 2rem;">
    <h1>Match Prediction</h1>
    <p>Select teams and players to simulate T20 matches</p>
    
    <!-- Gender Toggle -->
    <div style="margin-top: 1rem; display: flex; justify-content: center; gap: 1rem;">
        <button id="gender-male" class="btn btn-primary" onclick="setGender('male')" style="min-width: 150px;">
            üèè Men's T20
        </button>
        <button id="gender-female" class="btn" onclick="setGender('female')" style="min-width: 150px;">
            üèè Women's T20
        </button>
    </div>
</div>

<!-- WBBL Quick Load Section (Women's only) -->
<div id="wbbl-loader" class="card" style="display: none; margin-bottom: 1.5rem; border: 2px solid var(--accent-primary);">
    <h2 class="card-title" style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="font-size: 1.5rem;">üèè</span> Load WBBL Match
    </h2>
    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
        Select an upcoming WBBL match to auto-fill both teams with their most recent lineups.
    </p>
    
    <div class="grid grid-2" style="gap: 1rem; align-items: end;">
        <div class="form-group" style="margin: 0;">
            <label>Upcoming WBBL Fixtures</label>
            <select id="wbbl-fixture-select" style="width: 100%;">
                <option value="">-- Select a Match --</option>
            </select>
        </div>
        <div class="form-group" style="margin: 0;">
            <button class="btn btn-primary" onclick="loadWBBLMatch()" style="width: 100%;">
                Load Squads
            </button>
        </div>
    </div>
    
    <div id="wbbl-loading" style="display: none; text-align: center; padding: 1rem;">
        <div class="spinner" style="margin: 0 auto;"></div>
        <p style="color: var(--text-secondary); margin-top: 0.5rem;">Loading squads from API...</p>
    </div>
    
    <div id="wbbl-match-info" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <strong id="wbbl-match-name"></strong>
            <span id="wbbl-match-date" style="color: var(--text-muted);"></span>
        </div>
        <div style="font-size: 0.875rem; color: var(--text-secondary);">
            <span id="wbbl-team1-info"></span> vs <span id="wbbl-team2-info"></span>
        </div>
    </div>
</div>

<div class="grid grid-2">
    <!-- Team 1 Selection -->
    <div class="card">
        <h2 class="card-title" style="color: var(--accent-primary);">Team 1</h2>
        
        <div class="form-group">
            <label>Select Team</label>
            <select id="team1-select" onchange="loadPlayers(1)">
                <option value="">-- Select Team --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Batters (select 11)</label>
            <select id="team1-batters" multiple size="8" style="min-height: 200px;">
            </select>
            <small style="color: var(--text-muted);">Hold Ctrl/Cmd to select multiple</small>
        </div>
        
        <div class="form-group">
            <label>Bowlers (select 5)</label>
            <select id="team1-bowlers" multiple size="5" style="min-height: 120px;">
            </select>
        </div>
    </div>
    
    <!-- Team 2 Selection -->
    <div class="card">
        <h2 class="card-title" style="color: var(--accent-secondary);">Team 2</h2>
        
        <div class="form-group">
            <label>Select Team</label>
            <select id="team2-select" onchange="loadPlayers(2)">
                <option value="">-- Select Team --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Batters (select 11)</label>
            <select id="team2-batters" multiple size="8" style="min-height: 200px;">
            </select>
            <small style="color: var(--text-muted);">Hold Ctrl/Cmd to select multiple</small>
        </div>
        
        <div class="form-group">
            <label>Bowlers (select 5)</label>
            <select id="team2-bowlers" multiple size="5" style="min-height: 120px;">
            </select>
        </div>
    </div>
</div>

<!-- Venue Selection -->
<div class="card">
    <h2 class="card-title">Match Conditions</h2>
    <div class="grid grid-2">
        <div class="form-group">
            <label>Venue (affects scoring patterns)</label>
            <select id="venue-select">
                <option value="">-- Neutral Venue --</option>
            </select>
            <small style="color: var(--text-muted);" id="venue-info"></small>
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="use-toss" style="width: auto;">
                Simulate Toss
            </label>
            <small style="color: var(--text-muted);">Uses historical bat/field preferences (T20: 55% elect to field)</small>
        </div>
    </div>
</div>

<!-- Simulation Options -->
<div class="card">
    <h2 class="card-title">Simulation Options</h2>
    <div class="grid grid-3">
        <div class="form-group">
            <label>Simulator Engine</label>
            <select id="simulator-type">
                <option value="fast">Fast Lookup (0.1ms/match)</option>
                <option value="nn">Neural Network (5ms/match)</option>
            </select>
        </div>
        <div class="form-group">
            <label>Number of Simulations</label>
            <input type="number" id="n-simulations" value="1000" min="100" max="10000" step="100">
        </div>
        <div class="form-group">
            <label>&nbsp;</label>
            <button class="btn btn-primary" onclick="runSimulation()" style="width: 100%;">
                Run Simulation
            </button>
        </div>
    </div>
</div>

<!-- Results -->
<div id="results" class="card" style="display: none;">
    <h2 class="card-title">Prediction Results</h2>
    
    <div class="grid grid-2" style="margin-bottom: 2rem;">
        <!-- Team 1 Result -->
        <div style="text-align: center; padding: 2rem; background: var(--bg-tertiary); border-radius: 12px;">
            <div style="font-size: 1.25rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                <span id="result-team1-name">Team 1</span>
            </div>
            <div class="stat-value" style="color: var(--accent-primary);" id="result-team1-prob">--%</div>
            <div class="probability-bar">
                <div class="probability-fill" id="result-team1-bar" style="background: var(--accent-primary); width: 0%;"></div>
            </div>
            <div style="margin-top: 1rem; color: var(--text-secondary);">
                Avg Score: <span id="result-team1-score">--</span>
            </div>
            <div style="color: var(--text-muted); font-size: 0.875rem;">
                Range: <span id="result-team1-range">-- - --</span>
            </div>
        </div>
        
        <!-- Team 2 Result -->
        <div style="text-align: center; padding: 2rem; background: var(--bg-tertiary); border-radius: 12px;">
            <div style="font-size: 1.25rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                <span id="result-team2-name">Team 2</span>
            </div>
            <div class="stat-value" style="color: var(--accent-secondary);" id="result-team2-prob">--%</div>
            <div class="probability-bar">
                <div class="probability-fill" id="result-team2-bar" style="background: var(--accent-secondary); width: 0%;"></div>
            </div>
            <div style="margin-top: 1rem; color: var(--text-secondary);">
                Avg Score: <span id="result-team2-score">--</span>
            </div>
            <div style="color: var(--text-muted); font-size: 0.875rem;">
                Range: <span id="result-team2-range">-- - --</span>
            </div>
        </div>
    </div>
    
    <div id="toss-result" style="text-align: center; margin-bottom: 1rem; display: none;">
        <div style="background: var(--bg-secondary); padding: 0.75rem 1rem; border-radius: 8px; display: inline-block;">
            üé≤ Toss: <span id="toss-winner-text"></span> won and elected to <span id="toss-decision-text"></span>
        </div>
    </div>
    
    <div style="text-align: center; color: var(--text-muted); font-size: 0.875rem;">
        <span id="result-meta"></span>
    </div>
</div>

<!-- Loading -->
<div id="loading" class="card" style="display: none;">
    <div class="loading">
        <div class="spinner"></div>
    </div>
    <p style="text-align: center; color: var(--text-secondary);">Running simulations...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Current gender selection
    let currentGender = 'male';
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadTeams();
        loadVenues();
    });
    
    function setGender(gender) {
        currentGender = gender;
        
        // Update button styles
        document.getElementById('gender-male').className = gender === 'male' ? 'btn btn-primary' : 'btn';
        document.getElementById('gender-female').className = gender === 'female' ? 'btn btn-primary' : 'btn';
        
        // Show/hide WBBL loader (women's only)
        const wbblLoader = document.getElementById('wbbl-loader');
        if (gender === 'female') {
            wbblLoader.style.display = 'block';
            loadWBBLFixtures();
        } else {
            wbblLoader.style.display = 'none';
        }
        
        // Reload teams and venues for new gender
        loadTeams();
        loadVenues();
        
        // Clear player selections
        ['team1-batters', 'team1-bowlers', 'team2-batters', 'team2-bowlers'].forEach(id => {
            document.getElementById(id).innerHTML = '';
        });
        ['team1-select', 'team2-select'].forEach(id => {
            document.getElementById(id).value = '';
        });
        
        // Clear WBBL match info
        document.getElementById('wbbl-match-info').style.display = 'none';
        
        // Update subtitle
        const genderText = gender === 'male' ? "Men's" : "Women's";
        document.querySelector('.hero p').textContent = `Select teams and players to simulate ${genderText} T20 matches`;
    }
    
    // WBBL Functions
    async function loadWBBLFixtures() {
        try {
            const response = await fetch('/api/wbbl/fixtures');
            const data = await response.json();
            
            if (data.success) {
                const select = document.getElementById('wbbl-fixture-select');
                select.innerHTML = '<option value="">-- Select a Match --</option>';
                
                data.fixtures.forEach(fixture => {
                    const opt = document.createElement('option');
                    opt.value = fixture.id;
                    opt.textContent = `${fixture.date}: ${fixture.team1.replace(' Women', '')} vs ${fixture.team2.replace(' Women', '')}`;
                    select.appendChild(opt);
                });
            }
        } catch (error) {
            console.error('Error loading WBBL fixtures:', error);
        }
    }
    
    async function loadWBBLMatch() {
        const matchId = document.getElementById('wbbl-fixture-select').value;
        if (!matchId) {
            alert('Please select a match first');
            return;
        }
        
        // Show loading
        document.getElementById('wbbl-loading').style.display = 'block';
        document.getElementById('wbbl-match-info').style.display = 'none';
        
        try {
            const response = await fetch(`/api/wbbl/match/${matchId}`);
            const data = await response.json();
            
            document.getElementById('wbbl-loading').style.display = 'none';
            
            if (data.success && data.match) {
                const match = data.match;
                
                // Show match info
                document.getElementById('wbbl-match-name').textContent = `${match.team1_db_name} vs ${match.team2_db_name}`;
                document.getElementById('wbbl-match-date').textContent = match.date;
                
                let venueInfo = match.venue_db_name ? `üìç ${match.venue_db_name}` : '';
                document.getElementById('wbbl-team1-info').textContent = `${match.team1_squad.filter(p => p.matched).length}/${match.team1_squad.length} players`;
                document.getElementById('wbbl-team2-info').textContent = `${match.team2_squad.filter(p => p.matched).length}/${match.team2_squad.length} players`;
                document.getElementById('wbbl-match-info').style.display = 'block';
                
                // Auto-fill teams
                await autoFillTeam(1, match.team1_db_name, match.team1_squad, match.team1_suggested_xi);
                await autoFillTeam(2, match.team2_db_name, match.team2_squad, match.team2_suggested_xi);
                
                // Auto-select venue if we found a match
                if (match.venue_db_id) {
                    const venueSelect = document.getElementById('venue-select');
                    venueSelect.value = match.venue_db_id;
                    console.log(`Auto-selected venue: ${match.venue_db_name} (ID: ${match.venue_db_id})`);
                }
                
                // Enable toss simulation for upcoming matches (it's more realistic)
                document.getElementById('use-toss').checked = true;
                
            } else {
                alert('Error loading match: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            document.getElementById('wbbl-loading').style.display = 'none';
            console.error('Error loading WBBL match:', error);
            alert('Error loading match data');
        }
    }
    
    async function autoFillTeam(teamNum, teamName, squad, suggestedXI) {
        // Find and select the team
        const teamSelect = document.getElementById(`team${teamNum}-select`);
        for (let opt of teamSelect.options) {
            if (opt.textContent === teamName) {
                teamSelect.value = opt.value;
                break;
            }
        }
        
        // Load players for this team
        await loadPlayers(teamNum);
        
        // Small delay to ensure DOM is updated
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Select the suggested XI in batters list
        const battersSelect = document.getElementById(`team${teamNum}-batters`);
        const bowlersSelect = document.getElementById(`team${teamNum}-bowlers`);
        
        // Clear current selections
        for (let opt of battersSelect.options) opt.selected = false;
        for (let opt of bowlersSelect.options) opt.selected = false;
        
        // Select suggested players
        let battersSelected = 0;
        let bowlersSelected = 0;
        
        for (let playerId of suggestedXI) {
            // Try to select in batters list
            for (let opt of battersSelect.options) {
                if (parseInt(opt.value) === playerId && battersSelected < 11) {
                    opt.selected = true;
                    battersSelected++;
                    break;
                }
            }
            
            // Also try bowlers list
            for (let opt of bowlersSelect.options) {
                if (parseInt(opt.value) === playerId && bowlersSelected < 5) {
                    opt.selected = true;
                    bowlersSelected++;
                }
            }
        }
        
        console.log(`Team ${teamNum}: Selected ${battersSelected} batters, ${bowlersSelected} bowlers`);
    }
    
    async function loadTeams() {
        try {
            const response = await fetch(`/api/teams?gender=${currentGender}`);
            const data = await response.json();
            
            if (data.success) {
                ['team1-select', 'team2-select'].forEach(selectId => {
                    const select = document.getElementById(selectId);
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">-- Select Team --</option>';
                    data.teams.forEach(team => {
                        const opt = document.createElement('option');
                        opt.value = team.team_id;
                        opt.textContent = team.name;
                        select.appendChild(opt);
                    });
                    select.value = currentValue;
                });
            }
        } catch (error) {
            console.error('Error loading teams:', error);
        }
    }
    
    async function loadVenues() {
        try {
            const response = await fetch(`/api/venues?gender=${currentGender}`);
            const data = await response.json();
            
            if (data.success) {
                const venueSelect = document.getElementById('venue-select');
                venueSelect.innerHTML = '<option value="">-- Neutral Venue --</option>';
                data.venues.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.venue_id;
                    opt.textContent = `${v.name}${v.city ? ', ' + v.city : ''} (${v.match_count} matches)`;
                    venueSelect.appendChild(opt);
                });
            }
        } catch (error) {
            console.error('Error loading venues:', error);
        }
    }
    
    async function loadPlayers(teamNum) {
        const teamId = document.getElementById(`team${teamNum}-select`).value;
        if (!teamId) return;
        
        const response = await fetch(`/api/players/${teamId}?gender=${currentGender}`);
        const data = await response.json();
        
        if (data.success) {
            // Populate batters
            const battersSelect = document.getElementById(`team${teamNum}-batters`);
            battersSelect.innerHTML = '';
            data.batters.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.player_id;
                opt.textContent = `${p.name} (${p.total_runs} runs)`;
                battersSelect.appendChild(opt);
            });
            
            // Populate bowlers
            const bowlersSelect = document.getElementById(`team${teamNum}-bowlers`);
            bowlersSelect.innerHTML = '';
            data.bowlers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.player_id;
                opt.textContent = `${p.name} (${p.total_wickets} wkts)`;
                bowlersSelect.appendChild(opt);
            });
            
            // Auto-select top players
            selectTop(battersSelect, 11);
            selectTop(bowlersSelect, 5);
        }
    }
    
    function selectTop(selectEl, n) {
        const options = selectEl.options;
        for (let i = 0; i < Math.min(n, options.length); i++) {
            options[i].selected = true;
        }
    }
    
    function getSelectedValues(selectId) {
        const select = document.getElementById(selectId);
        return Array.from(select.selectedOptions).map(opt => parseInt(opt.value));
    }
    
    async function runSimulation() {
        const team1Name = document.getElementById('team1-select').selectedOptions[0]?.text || 'Team 1';
        const team2Name = document.getElementById('team2-select').selectedOptions[0]?.text || 'Team 2';
        
        const team1Batters = getSelectedValues('team1-batters');
        const team1Bowlers = getSelectedValues('team1-bowlers');
        const team2Batters = getSelectedValues('team2-batters');
        const team2Bowlers = getSelectedValues('team2-bowlers');
        
        if (team1Batters.length === 0 || team2Batters.length === 0) {
            alert('Please select players for both teams');
            return;
        }
        
        // Get venue and toss options
        const venueSelect = document.getElementById('venue-select');
        const venueId = venueSelect.value ? parseInt(venueSelect.value) : null;
        const useToss = document.getElementById('use-toss').checked;
        
        // Show loading
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results').style.display = 'none';
        
        const payload = {
            team1_batters: team1Batters,
            team1_bowlers: team1Bowlers,
            team2_batters: team2Batters,
            team2_bowlers: team2Bowlers,
            simulator: document.getElementById('simulator-type').value,
            n_simulations: parseInt(document.getElementById('n-simulations').value),
            venue_id: venueId,
            use_toss: useToss,
            gender: currentGender
        };
        
        try {
            const response = await fetch('/api/simulate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const data = await response.json();
            
            document.getElementById('loading').style.display = 'none';
            
            if (data.success) {
                // Update results
                document.getElementById('result-team1-name').textContent = team1Name;
                document.getElementById('result-team2-name').textContent = team2Name;
                
                document.getElementById('result-team1-prob').textContent = data.team1_win_prob + '%';
                document.getElementById('result-team2-prob').textContent = data.team2_win_prob + '%';
                
                document.getElementById('result-team1-bar').style.width = data.team1_win_prob + '%';
                document.getElementById('result-team2-bar').style.width = data.team2_win_prob + '%';
                
                document.getElementById('result-team1-score').textContent = data.avg_team1_score;
                document.getElementById('result-team2-score').textContent = data.avg_team2_score;
                
                document.getElementById('result-team1-range').textContent = 
                    `${data.team1_score_range[0]} - ${data.team1_score_range[1]}`;
                document.getElementById('result-team2-range').textContent = 
                    `${data.team2_score_range[0]} - ${data.team2_score_range[1]}`;
                
                // Show toss info if available
                const tossResult = document.getElementById('toss-result');
                if (data.toss_info) {
                    document.getElementById('toss-winner-text').textContent = data.toss_info.winner;
                    document.getElementById('toss-decision-text').textContent = data.toss_info.decision;
                    tossResult.style.display = 'block';
                } else {
                    tossResult.style.display = 'none';
                }
                
                // Build meta string
                let meta = `${data.n_simulations.toLocaleString()} simulations using ${data.simulator === 'nn' ? 'Neural Network' : 'Fast Lookup'} engine in ${data.elapsed_ms}ms`;
                if (data.h2h_rate !== null) {
                    meta += ` | H2H data used: ${data.h2h_rate}%`;
                }
                if (data.venue_id) {
                    meta += ` | Venue #${data.venue_id}`;
                }
                document.getElementById('result-meta').textContent = meta;
                
                document.getElementById('results').style.display = 'block';
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            document.getElementById('loading').style.display = 'none';
            alert('Error running simulation: ' + error.message);
        }
    }
</script>
{% endblock %}
