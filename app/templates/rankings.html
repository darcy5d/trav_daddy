{% extends "base.html" %}

{% block title %}ELO Rankings - Cricket Predictor{% endblock %}

{% block content %}
<div class="hero" style="padding: 2rem;">
    <h1>ELO Rankings</h1>
    <p id="rankings-subtitle">Current T20 Men's ratings based on historical performance</p>
</div>

<!-- Filter Controls -->
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap: 1rem;">
        <div class="form-group">
            <label>Format</label>
            <select id="format-select" onchange="loadRankings()">
                <option value="T20" selected>T20</option>
            </select>
        </div>
        <div class="form-group">
            <label>Gender</label>
            <select id="gender-select" onchange="loadRankings()">
                <option value="male">Men's</option>
                <option value="female">Women's</option>
            </select>
        </div>
        <div class="form-group">
            <label>Min Matches (Teams)</label>
            <select id="min-matches-select" onchange="loadRankings()">
                <option value="5">5+</option>
                <option value="10" selected>10+</option>
                <option value="20">20+</option>
                <option value="30">30+</option>
                <option value="50">50+</option>
            </select>
        </div>
        <div class="form-group">
            <label>Historical Month</label>
            <select id="month-select" onchange="loadRankings()">
                <option value="">Current</option>
            </select>
        </div>
    </div>
</div>

<div class="grid grid-3">
    <!-- Team Rankings -->
    <div class="card">
        <h2 class="card-title">Team Rankings</h2>
        <div id="team-rankings">
            <div class="loading"><div class="spinner"></div></div>
        </div>
    </div>
    
    <!-- Batting Rankings -->
    <div class="card">
        <h2 class="card-title">Top Batters</h2>
        <div id="batting-rankings">
            <div class="loading"><div class="spinner"></div></div>
        </div>
    </div>
    
    <!-- Bowling Rankings -->
    <div class="card">
        <h2 class="card-title">Top Bowlers</h2>
        <div id="bowling-rankings">
            <div class="loading"><div class="spinner"></div></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadAvailableMonths() {
        try {
            const response = await fetch('/api/rankings/months');
            const data = await response.json();
            
            if (data.success) {
                const select = document.getElementById('month-select');
                data.months.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    // Format as "Nov 2025" style
                    const [year, mon] = month.split('-');
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    option.textContent = `${monthNames[parseInt(mon) - 1]} ${year}`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading months:', error);
        }
    }

    async function loadRankings() {
        const format = document.getElementById('format-select').value;
        const gender = document.getElementById('gender-select').value;
        const minMatches = document.getElementById('min-matches-select').value;
        const month = document.getElementById('month-select').value;
        
        // Update subtitle
        const genderText = gender === 'male' ? "Men's" : "Women's";
        const periodText = month ? `${month}` : 'Current';
        document.getElementById('rankings-subtitle').textContent = 
            `${periodText} ${format} ${genderText} ratings (min ${minMatches} matches)`;
        
        // Build query string
        const params = new URLSearchParams({
            format: format,
            gender: gender,
            min_matches: minMatches
        });
        if (month) params.append('month', month);
        
        // Show loading
        ['team-rankings', 'batting-rankings', 'bowling-rankings'].forEach(id => {
            document.getElementById(id).innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        });
        
        // Load team rankings
        try {
            const teamResponse = await fetch(`/api/rankings/teams?${params}`);
            const teamData = await teamResponse.json();
            
            if (teamData.success) {
                const container = document.getElementById('team-rankings');
                if (teamData.rankings.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No teams meet the criteria</p>';
                } else {
                    container.innerHTML = teamData.rankings.map((t, i) => `
                        <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                            <div>
                                <span style="color: var(--text-muted); width: 2rem; display: inline-block;">${i + 1}.</span>
                                <span>${t.name}</span>
                                <span style="color: var(--text-muted); font-size: 0.7rem; margin-left: 0.5rem;">(${t.matches})</span>
                            </div>
                            <span style="font-family: 'JetBrains Mono', monospace; color: var(--accent-primary);">
                                ${t.elo}
                            </span>
                        </div>
                    `).join('');
                }
            }
        } catch (error) {
            console.error('Error loading team rankings:', error);
        }
        
        // Load batting rankings (only for current, not historical)
        if (!month) {
            try {
                const battingResponse = await fetch(`/api/rankings/batting?${params}&min_matches=5`);
                const battingData = await battingResponse.json();
                
                if (battingData.success) {
                    const container = document.getElementById('batting-rankings');
                    if (battingData.rankings.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No players meet the criteria</p>';
                    } else {
                        container.innerHTML = battingData.rankings.map((p, i) => `
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                                <div style="flex: 1;">
                                    <span style="color: var(--text-muted); width: 2rem; display: inline-block;">${i + 1}.</span>
                                    <span>${p.name}</span>
                                    <span style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-left: 2rem;">${p.team || ''}</span>
                                </div>
                                <span style="font-family: 'JetBrains Mono', monospace; color: var(--accent-secondary);">
                                    ${p.elo}
                                </span>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading batting rankings:', error);
            }
            
            // Load bowling rankings
            try {
                const bowlingResponse = await fetch(`/api/rankings/bowling?${params}&min_matches=5`);
                const bowlingData = await bowlingResponse.json();
                
                if (bowlingData.success) {
                    const container = document.getElementById('bowling-rankings');
                    if (bowlingData.rankings.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No players meet the criteria</p>';
                    } else {
                        container.innerHTML = bowlingData.rankings.map((p, i) => `
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                                <div style="flex: 1;">
                                    <span style="color: var(--text-muted); width: 2rem; display: inline-block;">${i + 1}.</span>
                                    <span>${p.name}</span>
                                    <span style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-left: 2rem;">${p.team || ''}</span>
                                </div>
                                <span style="font-family: 'JetBrains Mono', monospace; color: var(--accent-warning);">
                                    ${p.elo}
                                </span>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading bowling rankings:', error);
            }
        } else {
            // For historical months, show message that player data is not available
            document.getElementById('batting-rankings').innerHTML = 
                '<p style="color: var(--text-muted); text-align: center; font-size: 0.9rem;">Player history not available.<br>Select "Current" to view player rankings.</p>';
            document.getElementById('bowling-rankings').innerHTML = 
                '<p style="color: var(--text-muted); text-align: center; font-size: 0.9rem;">Player history not available.<br>Select "Current" to view player rankings.</p>';
        }
    }
    
    // Load on page ready
    document.addEventListener('DOMContentLoaded', () => {
        loadAvailableMonths();
        loadRankings();
    });
</script>
{% endblock %}
